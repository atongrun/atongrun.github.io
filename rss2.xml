<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>å­™èœèœ</title>
    <link>https://atong.run/</link>
    
    <atom:link href="https://atong.run/rss2.xml" rel="self" type="application/rss+xml"/>
    
    <description>ä¸‡åƒä¸å¦‚æ„ï¼Œç¡å¾—ç€å°±è¿‡å¾—å»</description>
    <pubDate>Sat, 04 Mar 2023 02:42:19 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title>ChatGPTè¶Šç‹±æˆåŠŸï¼Œè§£é”æš—é»‘ç‰ˆæœ¬çš„ChatGPTï¼Œçªç ´openaiå¯¹chatgptå›ç­”é™åˆ¶ã€‚</title>
      <link>https://atong.run/posts/3439780086/</link>
      <guid>https://atong.run/posts/3439780086/</guid>
      <pubDate>Sat, 04 Mar 2023 02:31:10 GMT</pubDate>
      
      <description>æœ‰ä¸œè¥¿è¢«åŠ å¯†äº†, è¯·è¾“å…¥å¯†ç æŸ¥çœ‹.</description>
      
      
      
      <content:encoded><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="æŠ±æ­‰, è¿™ä¸ªå¯†ç çœ‹ç€ä¸å¤ªå¯¹, è¯·å†è¯•è¯•." data-whm="æŠ±æ­‰, è¿™ä¸ªæ–‡ç« ä¸èƒ½è¢«æ ¡éªŒ, ä¸è¿‡æ‚¨è¿˜æ˜¯èƒ½çœ‹çœ‹è§£å¯†åçš„å†…å®¹.">  <script id="hbeData" type="hbeData" data-hmacdigest="af4f1067a7e93433094a533d1d40cf8ab67fe61ac905c8b7e69954b381802fb5">1ed55b8cb92b79ea9baaafe6182315e0958894f99c20a7bf80f66cdf9a3e14be9affe115514b8e553364f6025d4d79aaae32cf9110007914cf165770f109c3dbde6cb247ddeec55d4c9e848750a8c3203c911dd55191761474c139d64aaa17fce04cf9d8ec42f3ffc9ac4bbe283e2b784e1adbd3d3c69ae58f5c9e3812035cbb2b1aadecdc25c42e535de980ef59f238f62a417249f82084c066182bec2dd88d7b518b6e7ade36f4d95f975dcd8d2f0ea5afced1f9c1203f42ca9066d89cde494574766728cdc335c33d5024899b3e20ce179c1a977ba2e974430acd8333380d84e76d4be17e4b232717d5fb0e0b5823cb6bd23d22730a017b44e619b7d4a77dba62c3b57b408457c953632136826bd05e578bb8ce2e405532ff20a589d0126ab175e54bdf112e8ba0642efaf886f13d9899d9e171385463d5c30c3539dc446181d9053929bacc77b136dbd567d6fc21aff7876a82224f39767086cea2a683d90ed014ffb4d09dcb3ae3c7a67d725b6ab7441a87fb574dbb5592d98a1e0e608fc7163face3d922aca33727c9946a43e7174eb0640711009203ce92f1bbd4be26b697b3af9adc18db1d8c7f8d01ee53eff2d7acc37c50d161db6cb9e71c663bd98d43baaad3d31cc73eda6102525c21ed14a8831ac178d0c056c0ac36a4b25cb916de3b0b9f3510000eb8da35ba648ed3b21fa49086594b9a149d60584cc4fa61a1306012281d8f4b2b168b080da69b230c37d83384735fbfe4cc4e83163a3dd02b559a36e66cbaefa6dfa1f833ab7e0090f0b82924607ce89cacc479dacd68b8ab79b6e70b971bc1eae049444b33d4d08873536eccebe859f434e25183942224649d5e90e503b03217a81335e441ec7bcdece8d2a8a96e3012403a9de984b071a8a92f51d93f4a68e2bfc877ed39665ba935ade32a84806ae5bbf9ad05dc3b21e5c702826f981b736ff0fd635f5a5205cdb3adb12c1f67a05c1059cf8278f37978b5c916efc2199823deb9ba050092430d392a476e3961df3e5c156c37b700319c78e7a9e9fb81501a4a17e18df82f13ebb6d25aa6d26819748b5f5ecf3802504db85e10844c996e44e323f3ae6948117e1b768966516a36444e75ce12a441d3bb8446b9264f036c3834d000bd20b139abbf952db0d417928745e56b06cab36eb5e8699a71ee8fa80af750ad6b7324e66f5d29d37c102e9a704c63e774d9da4e6abd2c4f0790fdbc2d116084250cf195f6420ac60dc302e4625a05b1c9c8f318067c2b97e0bb4ef15aa3864dbca9c09c551db234c44083101580f99a33d2a9a7f3a46806e5620810ad925db70882e630a23a2bdfc056072d3527fbdb96105d68a33831e9a7f5cbc92f04bd5b3476cf72565b391e40043e4fd96eeb0125f85641db069d18cf6b7fa4d891bb444dc1c66f1f1ec271d5f39541a125f8e02ffd64a7e5b0459909cdfefe09c477d731dadc0ace93f2f7a5dfc77e79c7dad32a3097360486d98ea1be66d13669dcca036cd624c8737efebb600967595f2e2bf161e6b6d4af167dc8f422b8d85f6dbab4b4a3ae682971c2cd2d5aaa1c2478e6cc149279204d175b98a9b4e5d9aecd11641c9e92177c07d87d977377f7292dd375083aa40bd72f831589743a4dcbc6a5f85a28f48412ed3588d0f066e275d903dcb63cdb14c5c8b19d98fce7cb12e6cfc3c674e2ed45d07fbd38dbcbf6fd2063d5262d9d37a23c5d0b24729b6580c745643d945f2655d6e364fc15eb1c76467fab4de19247d9cc30dd029c2df39e440a08a2827b9eae8a4bae3fc5ccb1899f79850bfe4c64a274af8f4bceb0f452579064263c63e4c495b3f71987bb60b2b186d082ac16fee1bd5d1b19cb7971a89137b45fce4741fb732d63b6a9dd42d3df290ccf0f4d090fd2823034015d0a29a7c3d621f7bfd99e0a08d06b4022ba361fdc7a8cfa8f2dc2a7f3cb59ead7965f421f94dd43fb9e67c4769db852c9346d7a4afe273b1266e1db4995fb85aab0abf97d3a6600e2ddce9b5e46d38deb546c5b8356a176de394df8b976b1afa93fd2cdd64d19cdc563078d29eb295057ef3319c80f40152c2292d271c700588e3f1ad816e59ab59c0135e7dce3c9521740d32f8d7b49589c21f532d60923b78e78822b55fafc4bb61fb740581281de57426c90205fa08d7c6ce33da188579795c01c135463e62c196d11757a3924e60f7c4e183adfd4d772843355c70d939d62997b11d23255a19721a1a0815eb97ff72c5e769d58ca008536808f52cfe739600ad91f66e5a3a94f53f1c1cccf229cc7e53331aa02c2f2ba2adf6c45e8e32bfdf4a0234a73ad5d527ecad0d237f7f2b99990712c1b5a236e222af4cd28d93131c3e169fbf606e2d1101f22fe7fd8d98ec9153487ad40fb6007122ed759d7399caaa4e95458aadd368eb678e5130c33110f5a0b51e49daa04f5a130784114400d6e1c7f580fc02d257f6acaa12ea69b8ded40d4ffaa4a0593bc9c7a4f5c6a05a26501b739b85af2d8d7c3871076016456156495f40d7bfe67186173acbd0b019217de40f9da24618898c9a26c0c1c788c6447592878cbb62ae7104621096428edfabf04ef15ee5fa35b0e241eb61840fe4562928af4aaff2f1ef08df21a004d833c02127971444fcba6fe285d13292e272596b7632c99707cbc0f8a4ad135c0dcfa72c9d8cb62507d2acacada15cf6f8b2edabc5f0685b719b3e38ce793a9b9e599b62a011272c918145fd3c1e84c7ed10f33092446e316bb39590a919c58e35b59abd75a30063bd955b87ed38f22c6e455b1c6e57131c227f610de105f5bd2fdba569a5bc0f5c89bf330a9f6ee6b1dc5f9f9226c581078199bdc0abaca0fc64b36f86e366b3a8e513202a618a5f3ecfeeb394abc1f89ebd61a059135b1018d450b4ff3ea5e2819415a6c17ea8f723da162727bac6a6bb89574c830c81d75d3c70a59d8e04fbb0498a02a4783ca27638041773e35c02fad266b403745353ccf1d0b33451c0314a5a21a6522699143402c2e0ceade0e343ae63628c6f7e058ea884d446a2aca210d0ebf7a83b2947c1d3677f887a7fe02d807c15191fd071735d0b43aba1666527f0f4afff4698f139e4cfb8a1ced8fc736b9600d21b69f8326dcab6a180c8c1113bd60f097a26095e6759b2b3deca6f9f2cb8b691a694b89c3f5a451964f842bd103896672520d57cfd6c262c4147f8475a861a2e275733fdd9ddd61517d45340e6ecd2c2d3048f056ae9ac9b7f1de4cfed5cc549c3eff8d345cfbb0b6199e8a202027e48bb8dba1d49ea41d37cf498b25a3e21d44541e94a2bd91724f2a0a73276b7b1d234ff608fa67143d704aa96829d78fc0784c8eefae586e3541ceea6c7b292e826da44df78cc688c5c144458b9c669349b5e6f92afc0f3db16bc32f4f4446cb3da2e0442d356e6a8f5330eba78975ea15f798a843b56fda1a0de7435d5cbabd03190b3416e0f99b02369863a96b5c0f35384a746fb5b5ae3b825a162144996622401063a5ddb2681a6099ae18634683fc450325a16b1162ad087425d97ea3c1c220b38921d2cd0b8188f45faeeeba142cca633de331c181dd913d241128e9cf78f69192d733eb03ed01614ea3964834ab09456e2b2711dd48e06a288c8ae3bfbde2ab689fa5148ed17bc6e386c75a8157906b77352ff56822b6cbb24608bbdf627b587f0b7adbc2eac5521bf84003ebf6b74f149138dc0df74d7cd815465ae9978047a3fb37aa8f00a90fc4387d6236401f764bb6fda2e8810f3a367c9cbceca991436e845c9f42c65ed05c80ee60db3e3142afe81bb67b21e8eec517425b7c802054606273fe9cb9134e3f52dfbcfbb0207b0c9d12bd6e3ba0c2c9f8231526598f5134bbe8443f06734f7558850e909fd61adc32b87144d3c7bd2504eefd40008fa50c736a4046fc75a6f516fc24237d7e470e33bc6eb1ba02b747faa21245dea9807b95ccd09c98d25619e56fb8d3f6a84a0b5eed0899350ee520a21a165c90775ae9afb6b640409bd8d5643d565cabaec074b830386fef7c5ddbc93bba7e1b6becedd33752ad5c123ea48c64ddb3e3da9d851ec626a1c79f69d10990114122ec8ae96c19f33ea1e8d6781b64f097b2c420f90fc31eed0760c68eb4dd53089b6ed1390eb68d4e4ada518b9c80727156e63d72b159a9288b3157162cc0a932f0721eae95d38247d9251e4633471c70bc0153f2666d705720c879eaebdffda881780af67f877b160650b4f037534a5b3e140b97f4ecd487a7cd204b4f7c0e2dc366dce125b29d4f1c1b060b4e568df508c52f88bcd74228c3326b4a4fb5a984e63bc337263fd162b65d3118f3e4eee62e728d525cac81dba8c4a2579b8c746b483d4e488dcbc9f959fd7b673ad476dace632fd5f4c6f6578a65a5aa516772afe40560539a60d4f22e6db41f30073f3984cd726962c61a4caad6d6e4c027c4d3fea6a7b9c9a4c9622a54f2aad27cb8cc72052d6335c99992f8705123145d7388cb0267c89c99adf30c3be1c09efe25d5310cfe053aa2397f8842769554574d14b519872c673eedea8b2452841c46d380b75e4dd1939316d8ed8c111353d3bd5ba123e5f110e6642f964100616684d106ef28d939db750869f741431283f13ab793437e33576dd70ab7aeccad9567258aa6fa0026500aec2003ba82bcabd85821472b094b83fed2dcd5c1e9f19067ee78129b36ed56bf0b75177bf7a4568f788b1f4f2f7803513b479d62150aec1444c1d466677b93c2739a964fe70553e14e46ca3c1f63404ebb0651c0f5b4b974ebeb9f1b3d8b2311fc09206b9247fc9a7338db31ae0e6df318500c3bbf50f6e6a6c72b2bc14c4d5291260d22c19e0b89162712ca466b712d085761c47c866e574d5e868b73adc54e699b9c83b6ae72c3c4f37c4620526a556b28f3ea8e82fb0e173087eacb6ab2382bcec411883b1c4d95253e94483e36043eee0d1e8d7b821467a98d366a15b5fb7851a1911aa757ee2fbb04c9ffb19e16dd67333c824da5688d90cebb72af9a64b5555a471181dd4fa27d117302b4da59832aecec43890582ccd1575ee97a12ce21ccb8251a2f15a23171fabe714d1ab7934ce35b29f0e60fb2a8cc2857a4efba06a246222023fc9add14c103f4dfc73541fca89416beb4d4ff2b7277e85b262f64d1d5f6731e005bfaf4f3a802f90c89c71f722ff2818273a01a0a3e1a689343e0600c445debd1b02412d89c8e3e82f07652d38c3d172ff4edc3122f785f49987551eda61fa81b42f3617f5398d8a70a3b152a6443b40025d85072fc7e17c04a8db40efd78a900b627758f52da1457e11ed67b2aa395256032e470a9d0daa39344f35aae2b1e1aef073de8e4adc6a256bfbcbe800b842889f2119adb3e1641a5bf6cc325c340622167e6bf1cdcfa39acd91fceff51e255af098217863ad3b60ad3d18c42d874a2921a28ff07ed05c724519f8f1cc76fbac335486c5179beda5932e4e3552e6ab0f54e31ddfccb1ae864fd99c3eb21f90d4a40e9932c10e11091650f2d9219f62beb56ba7a6bebdd7f26732f76af4fba3be56889b051be5cb41f852132b938818605dea01698f44c40fa38eb664e5880f06030ac628d4d7456bb9dea9b8bc7792cc407258d9f1c274ac5eba32a4888c2e9c20950534eae9af78818cc393681b97576460d5b3db784ca94f7c4188d392d68be25b9f977d329b5b699841158e71d27bddfd9ca07c725d6bb6ff0886472d69311b29371fc9240ca5e7140acdd5662420b71631f09c039e616efc414a40a66e0b704dab0d620823e49c425156101c5705b249b9080212e6630069483931cdc954fa608b02c8f4d22d6434336785baa7822643e12310f4c1988b98ea431c227d258cbf19762fd6f0cd1e05b2c4777707801e57e2afc8cb8d579d22ec1bd95f9d76e3d14c58096ea0631b6245b53b34f6b266a0473011f364ade943f3a247e06d07dffc6e09f01518ff2b361a4f9f3272abe40f100ee1b1f22a88d3f51340eee9691969db5258fc5a0038ab24620de32463408bf32e48d79b42c6a67fc6a660b5c8014d8a7f89bf06c69dbdb23ad35e03abd183ddd8320237741f859be67be136474059691c79ee1687af23c2f8ce79d27108e7c4857b3ba992178aa99530e7296db01fba2889a35de4bf0ffeb1f57a8e140862fd5f5c22ca8030dd67fcf511d34149964dbb23f9d4b4b23daafcf6c94c4bc814d6a3f191d064137b55a175a4d94e19a6d44e94776c471a479d9ecb9c83d4fcfe0c2cf80ef37e4a1d773b8e185027c0d931cc406b79ad1f13d48374eb583fbd6331bf16e446cc720d2f20d6ad58cfc915fa11efe33988586d14ddc64e1c05dc48bc0194f3b03f948895c0b53ea089c50d213033bd820755dd7a583fcdec947965cbc858e4d398fe56469ad2c116ae3decd7aa950e5cd9ddb006f45406ec443cbad5fa4fedd56c4120b7411fe006f934e58926325f3fd006c5f9a154ecde6d1e94af1ccafe1639461ada36b63e88ad530e01375f52e4d6b49a7a0c7de06f338e62980ed7b6ec9377fe09a5a5aa8c07b8a0ecd57ea00332c078003bd4638654388f5659f56c425c3cad8758dfce4e1c9627483dfe96dd10e793d8bb07b61b97a05dde7cd6dcc5e056fe58ed995ddddee3b5f0a1b65f4d2b705a0c7a7a2823ee747c73b1e0ec64e724df0f4c188df217147ed7634eb411077611d82ad48fcc0fa762738b4918f72dc6a1357c44a2464140986500834091b6578ca5a7724a7dc1003af2d3c0318db94684bb21168e54eb0923d28df63e98c26790c5656adb5da00a13c7445db83770e53b546df2b3ee5d6b0984b80988c517b442e51e7458655b59af3b35e89b9e77fbea7040ee8ff75f03ea70823db876dadcfed741b6c163a815be99d894e920738d096cecee243fa51d9aedd430b2455c5e6977ad6249850163a1ecf359926e2e1c43d3dcd9b7f3659b69e9fa21bda2aee4e7b20c230d294ab7fb51764c5ae387de686b47c37db89d041024f8a939f84e440d69a6016977407059cd665357f0e225d0575e3989ced78f66ae320da6b48a4295df46342ac76139d2c236041caf447b08575061387fb20e75db786c19076e59c2db218638a4d3b99ebe4656acbb8caf5ab815f9a3cebbb55f497b496003b6561abb607aea5d6600602833bd8382393e56488f31430fbdd62450ad01b73352ef4d3f0a3b5508c0dbff7df12b02692a349e3ede507e10499915260352a09dd5ac0b71baf5687fa8387d4c9837a85b529bbea42e47c2dc210c365cddf11da555271bfa750246b409a5904d4feeef7784c9f66d19a4de257a605809a30c85fa211d31ca4dc87a711c044f518d4a9a58ad538959ec82fdc9f6cec3a62718edcb8f415ffe0ec0aec9cec4b95202eb625f1c57d30243a5604541bf1006bf73d4d32ac345d116d3fe74b3e8baa35479131adef5d2bea1f92387752cd8bda1515b1d1f14a226c355428823ac36b842efc461125582bebb73db5929ac25a8f30c928b639660450519f4d3b6e12f407bf8150edb3f62b1b63a995e5bc3165f5be2252681b672d46127230e885b18b2d39b7ae5a2f26c071f2d401658c7fd33fd891d37ef6193113d31730e4939f3eae19a966a25821afd2df7f77adfb145d17c032f2eb42ff67aa40578db877f84208f0582c214b51be47c81b41a8e408ef7f717bd5b9128c6463af969d500e29ad6c3b78a59ca70a34c49b6fdd05d936d2a067f5b3b9671507fc4018253fc0fbfcea77b6e8d607af15bb3d2a2c0176f0af824aa4e653b13dd499885ce203d88c490045c1c44e03ff08fd7d9c2a12f10dac35bf4110732c357137ff49ef71115fd0b67e4404b376a39bdc20530cf017f0f0a750eba6109f239ec164b2dae886d4370c29fb457729423226621757813df1005c253782aadd3769eb885b541c8dfc312e0dc927d7170901afeb7b3264a1e3b79680d4c765e085a3ecdbda6b89afbd6b8af6aedb6cc1005719497eaa0ff2542fdbad9551706ad711e049843d19969e588b4396f68f76698c2baa88a0dc041242e6e8d96a7f9808b689d34f4f2793f18eeedc8fa68b351c5d5f38ef0e91e8010fabde65e669e9ba446cfe8326da996ad0932ef395a2a83cc5c6f189a6f98f6b3d524f0712d6128c3e22a816e876fd3e62f1778838fdc9e4c22f2b02e4c368dca5a3d53373cad21365b0ef6588d66a605ce171ac04e2a058b61fdae5290e4760e8528645b756ea59112573e013f9b899d79ebb366d5f15f52226d826812a58c14da616971b88f6c0bf4bf60d2e7510a1c3d6d1518a6ad4bba7edb3fd511e59201d2636bf0c37babfda79814323a6202659114eab1808d237022a777478cad2ab4d02d6562761857d677999e4c7d4314c8cb4f4e97bf0992c479c8f88fafe0f4850e9a612a1aa94b66ede82f8123c60c9b9fc13213b3cbfe4853d7a62536e1c2728355c74759cfb0324052e066b7226a8ed8cdc10fdf99ee360429229e02949e656399d689a4e1f9b2269d292ec6c114e736fcd41d95d6301aff888ac76cb5b03b5a96451d43a5a9c7435d01d42235ae6700d82a167081549905a391a5822497d64f9a910081fb5cfd5e1c458900a215681f4255fddb68679f56d790ddbcad21ca4f794c0b75775fa297f18dfae15a922f8e7af4a3603e9bfd8992942877f97270f42baa5293b708ce7713620b8490eb5db029d35fe645a19d05e4926bb86276bcec4681b73a1ebabeaae5093ac5a6b1cab9e9e7b3fa1aa293a04a989ac92d8b25992cd2e298660a3f795562002b700f74e678d3af9e2c95c56e892cbcc7b605521d4c4c3c3bccd2b94c417144013a920413a138b5c43ccfe24e252553c7e27beffbe990093b292144d318f0c29a45d97a36defe21d30cfbcc407e6d80a4ae51146f1d4b65a81a2472cedc0c05202e04812897ff5149d306ff2e81a96230ff2510f7873ce695f38964104ff97c3a64e552d0d197166a27da70fc0576cfb398c83f8715fd5590b4f9dba52faab460b6cfbfb6a54563056478214df44b060bfe5883a28c2b5399d4bf9db895d4a9201b40f9e8c95f3f75114c84e36e56faaf168d64879a23278f9c2a1da4827494559abd6da18396d99ff36b1346a32c065a8216c0a2fa817cc91f6e108877e6a7c241b2205ab5d25591fa6435b2b70df57a301da11d22972e874a3b14176aad84542b63f34817f4ed75ac7aed32369646bff780f3b723564ad40202926781d6fe121c33e95422688f164dc6dc6dcfb48e195dd5ee0605ffe7b0d28bf208a4f254918f9cbec6e4636d21d35159729706393ab61e87363ebfc1d336a1d5917da33c93be70e7a0bd1e6603fe424c40909edaaa1fa0df52e36c272f9eb3b59fdd4c0c47a430cf66f6e9d3b8ab3240dc2ee5c710d87f55cdaf7bf5c625a386df6b243ab6f0fb30039e1905e9796b0351cee544cb95976b2a0ecf234d65e4c408966bfe521c6275600a105fd9e7d74d215dc7ef7dc8d1ad19e7b9d1af8052de6fdd9be5b675d3bdcf48561cd2cea824f61e2c7525c033e8ae7caeadf4863587966a5535f537c81a5d69da8bff99f233b5898cb0432f75253ac74e8f9365a4f179241710a73deaf6e340ff718caa54d04f39ac65b2caab6119b39c053c3bab4abf299f54a09c985b1e219f1ad73343eaee0d96700cf6845a8ce774097b658242df9587bf90e160bab533884b51ba627997edba3ed0d9a948b0b4c7a21ba1a900732edcbebbb8feda283d2ea06b5c2cad1d9125c29bb4f3527ea87473a06353a6479318bed8b58eae5a977a3a1bc09ccbcaba6f86724c9732b77ca6236ab5c06d86aa58a7764db9ae4e639afc0b2561eb5a03d43e7cbb734d57fd9851b7396fba54b578025da741d238090ba6c6b4cc2c278488a573081bd72bdb7f236e846c0ba1c8006857fae3b1a5d2787e60c10cdc4e9ee8bce125bc933ccb5c379a56e568e76062b9db6ebb85f3b75fb9d037894a8949e95e01de28172366e0a9addad84464009dbe20c478ac7ff59f25ecf977b74c56dfe1a487a847cb8cfebc57c827b53fb78877f679ced4699bd88a597670ed2e0ac9d6903d644a8713a32ba5919980129b741eda2f8f3b0764dbc9d875e33fb350219df5640e3c6e572268b7b0cda33950c78429372017ddb51ed3eff21a81f8f89d06964e10645129beaad4d33493f970d5857569a55e08f3c617f965d8e53a8654a3cc780526c5f24c9fa840e1053764ac76a08d2438ef75d7c4a8dcebba5556770b5d8b8188bcceaea2b3655b57c3646a577d417edc10ef997779575931a2635b970d64f653640a24d27a467981a525f559a6d8c83b17bada6f72283e69abd64decffa825e928e8ae61994486f6657868bc3e5240ee08928fb066cc12cc8ad468498b71d27508c6378d5b5c48603ad88d3fe049b44eeebd186f92b65f151cda2e50c513ff0c0bfc2529cf71aa290ef6c54d64f16f6d1d5908c1862756f672f5d7ba96658c4e62091871fb4704558d74e9d9d218e91f46516cae3767c45da614372372b0e86c915cd3a80553e455fa4e246e8776d03cf29fc21447f033f791858690faf75d34f4d6fe6535e3e4db6c7e4919b7373b5e06d8c61db110af0a03048275cf35d8877d91a353c03b2943a3490f65099c29c9470374a8da39eb31e02c33bea97e900e87008a28a88f04b9b23e67edc6cb722c63735ee52f309893b1001954034f6f1d2773c00c1b67d2e577c67aed1ffbd2e1bf7961179a6dd7bb0a99c97b3244dc710d2424970665c63dedc3c9caa347f1b20c63843f3cf4c3ec18b59e73ab2c329c959379a880b52f5cb836b830da4f6513dfd536279060d0f52e8cb9245c0f192d285754903cf002038570c940db04db73c2dd00bf85a589655dfdb67b5a1a1976ce35bfaaf694b402d8758590dbdb7771101b2f27a07ed2edc34587e33c71d05da2d41d077744a93e89df90670734656c2bbc24225c77e8053679293127c1c40afb4f376e2cc0d9ef8d1487bf31b1555970737de744eacef0cc933e2162f831cce358f4619fb48813170922813bb5ef74f3bb19b47ebeead1980682151faf70dd33d8ef75ad3294bd6de2cd7c5e2d50e1aacaf343e2b6d3308d7bb6b05f3cfced45f3b0e6371be51f9cad3eec4bcd98f95d9554316251506d062e22e00252c098c3e9cccc4da83232bc5604c1a3e5c28efc4a3a8115e0434ed34719adc6bc268f277f9c4e36dac98bade4772a8044d3e5c02fb8e1ef011492cfe94970a6564c654444443881f35503939b81d47991fd6d65117decedd302568891fccd527189cb1bc4040c0793d83d385034dc0ce179e36bb0ded26d60efbf84ff8ae69384bd59beb42ce96dde279a79aa6e50bdfc7ae6ca5335e47da830def6c265d87fa22b4819683754bd337bd6049a64ae5bf30f4826b432fe899f10b922f92f720d9a6286ca92946a8dc47d6ecddf14dd6914e0aacf51de00b82eb6c83eae2e236e4830224a7d8aa4504fe8cfcf88c41db8d49c6de2c7c2d84d5bf11165523b43c0090c1058051b6d1054a13ae2bc7365d03ee6918093a5702303dbcca7ef3c5c2a48fbb63e444c150053b8a500a8c89dafbecca924b9fa56afd8b2d17661d1941772a33affa7685bf14c3b3b37d098e55f7d6db2f93ab7aa149fe9e3dbac8566479e4cbe518147ac00a0783274466dad661805133b8bd99a0c1cdb6a0dfc645e4b3af54dfda8801f08ae1267720c15d2bca351e4ae38b666d598e13189eb373c7af97d64ef1aedf59549545612e40f0bb008fa986ec2166a0ef8ab40e080de053086421a8a026e01904daef5b1ae56d2cc0388e0b6e70f1b2c0592a2fa5f8676af4c78771b51ea526bd82a67fc48b2ab25276a1a378704bd03f7affd0eace3244daaa7fd67f5e64daecad1c34a1483cc09df4aa0a51e64f7dccbc2546529676d23d08552d00f53c5631c0265b01a212bf73fe3320783a70fe275efc29e53d81d926dae37a01d0bdb1b3018c8bff24b553063942c05740b6ab2ac0f5125aab3cc317784de26e548bd6f04344e5d54f0603b674e5a1fc20d95a1636de3d626851ae20e3ed118c54eda0e91a4af1b2dddacf315bff4a1c486a7d39eb09482a1c2c115f6649b55808caac3c6886d525c4948d869f9ddbfec44e8c0b2c28f743b8eb11a8bbe78f188b18b276dd33f0e164f7f305693aabd499c5b9767c96f8b9ee11c6ec4d4c452b22b056cf54c4a81ee83ac0da35dd640056ed59ee81a1379d910e1d8a5ddf351479a1114ffe3b5cc16c825162196ae0e98331fa983e72a25f3de9edd5b372508ffd35996d1c81d430647081846030651df8cb39246254c20a65030389bf064fbf5301de4676e1ba14893e4bc74501606dd235603b4eea95080a7d8aa5e565d496d5a7cb36a7fe87c0c97f1d8d40201b885df2f22341c0ea0e5c032e6847e7f7206a9d937759de2d85791e932e14d8722e1064e90df83da1bed124643db371ca5f6eaeb77bda106ca7730c043c53ce2594543032ab5a758abaaf7f33eb00c88a17df726fae039b513f611e4db3c778303f90ba1f303280704d41b00508a3430aff9d5d70956741874594913db090173ca3f8167f7abb2555e098409bc908dddc813658bd6f508067e94a710d40889edbe16569c3f867a5452bbf3b806effe9f3b1f0b20b727d8b49a0cd8f2c78b87d068a72a146c5a567e832c24c624af8c4ddca8f49b550617c48423290e6db09fc163ed1d8626d52264e00fd7c0257ea916664e7ce8e29f846a4ae5ca168a949542329357835db55679db7aa2e5ec9ae8780a5873e9afb17cb7f5e9325ffb72cb184c02682f779f3dc78abb289e5ba558dd592ff64079ede88afd52a2b49e34b99f64ccc7eb4eff060f6ea844adafdf7bfb0eec4953751f986a0b6c8502cad0e28b53507b3266b0ca280a708be7a271590e621d215452ef187dcf9d9b2c062fd34c7453408d95d3723698a1be521180a3ee024e3f3dde54f47e3ef05b6ce1d42a0e86b2fa65aecff034b6f1c1683b880f208f3667fb7f748e0b832753cceb8f52e53f72ec4d762dd8a53378618ae2f2584d275032d819c5eaace28fffe396abb71e21d7d75b867bfa0104ed68f7ad7e706ddcb7bb51d1298df8cf518feff163a543fcb11e811acd646216861a1ca8e415f8767f2803cbbe8a1432b18ccd4b1669e983690fabe997d5f6a2035be27ffa19fea1f8a2b91c801788f916bf52563fc835d2105fcee7abbba71b8e1641a478416eda301f622d747370a20c98d6077e909d42489eed783fc3a48e30655d41afc9e5385a89b56a02c6f84db7c9daf55c5087e1a5d58fd272476770e51f78aefb58fe5caff831bd4ad7f53975b4c5cf0110ccfaa0ea9b0eeddc981e8555f283afade1e9e180585a5fafbed1cdb94bcf37a914d836458371b7ae1eeaf7a5c38dd561ecd5ad7826289fbe617d5b23b9922a868c3c6ad7a86b199b9b6de659297c02a29c13e5ce9963aa078f3510bf9424e49ab769665c1b0f509601b8253b6cbec1229f004380e9e9d939db24aa35e1f3cc71eaf57e131cb56ab44c09ece581eeae374177fe7450f1f81cb7e29f443578ac8cca3606156939f1ceec16f68e833cf9a5232d332f821e19973361cc9b96a339a72694535428072f25c2993824daa136aeb5a2929ccb8f0638d2d6531650106e02a6cadaf297bf44dff8b7a758a2e36e1e883c53d832afe752bc5e0ee07af0107f3ee80e60d43e2e42d1dae3f97a198821023f59bd44ccb5b02959ead740ba65907700124af2ad91d6242c83613d4e24b7e0b619608cd52deba3ac7354560af2d06e565715197bf4c80a381b79fe2fe84b066fe22cc6d7ec0bbcd74cac619c4cbe98cfc8a0e84f5aa7330c39ed43b845e366384552620fd2d8edeab1b97ff256be77d8d0f52aa5750e09e8cb5a287e318b835771d2f1d2e6f6cf26d1341655c606c8afd39da90dcc6537950081bb8192397f7ff7ffd7a2df47e582fbc7f62beedcdd3952f8f6a5f008f598e29ca981fceee6d91e783f0a4e61d93891954e3ed20ef31c8f1b1045dcf6d1b4c496a79d065cfd043dbcfc4115eaaa26ba37589c11be7ee2a200599dddeda70f151203cbf66a2ecbf4e28592d466a457ec3b47d6a11e8bf200536a99bf0aa59a610c42d89dc731f8f78c810b193eb6dee72c08b67fdacf1692883b5d04318db33990254ba5328fb3a55fdddad3dbc7221c0cc44a9152422ac59623d24725b46f0a0706410e77567ca081bb809495e896e4463915a0a8723e71396d053b2499a5808967e8f8096c08bee2a6d408d8d8b46acbb3ca717f2165fbc75fdbed0b9850fb5dc24d45f4d7c6fc47cf29bfc91cbdfc0036854fce817f7d73e246db1ff24127d33ecbb14d3ee9c6978e1c5b7bff6367990bd458e7423f1b9597091640ae8324e65b4e203be6201317be904d19b1255e652a9b0c02e7ef8a77f8925e5c7f2907e0baed3aa7eeac4e7e93e6a4431b1fd3d97da50f72c9cef3d6de548d2627f67c1dddee38272c32e4bb65a9226d265c0eba03c9a55d253e4fdd932218f4f250d1b382728adc8a445906bbbf1a54beb22215f86915b442deacf3cc135a10fb08e8235ba3fb0a4809d75d961d24129a1ce913883c4854d95c0024339e1607efd03af4cf9d471dfda579feb066c36474c0b52fd9ec19ad607f311974edd53bc5a2699d53c819adf528c3bba19e6bf6ad9c09614be8d5ace999bb56058acae76df934c136336bb4a59b057bdbd5b97264cf230d39d61e28103553d5bdb98a74528fcb7a7a511223329daa48f6cc7feaf174fdcc35a6e14b56c3508444ffd94e6830e132f1223624b81260de6f0fb58b1ab832d1a44d1c211b7ff626812d85114afba8d1d54e4617ea58ef7f46676106a651f38473a0f48b684ed4d811ac1a6bb6d5d314960446edd63ccc24231ec66f6c040eceb85f77e8082c6ceab44a2e7f52648c72e511ccc3844b5c942c31fb5f4fc35e992521edb9a866f57b6af0e7a91594ba29985820dcf8d73550f9cc6b1920cd1c9eefde85eaba7de9db2bfdebd69a5a453b9dca303da85bd70fd6a3e6f155a04c4d4381a92d16ea325242f7d8579f41b2de2f846b8a1d910995d3bd0978ca6e27f3de5d1ea10ff79abd43783b46bd66ac0133f33fb1c08e6896652e4b384045c527538ea047ffe3b62841ad32755c2af138aca1f4d373c156c71820095bd32c7f7be5d6733a5636900a3861dbd694a87cf642f9e9ec94ecfda6b48a17a5800df719309a8e091465c1af57908d55803ed2df66fa292d23ed1bc771ccf71e896686aaf9e952492316f229769259e9968223e8b9f5ed151282e93007b6026b99959c552f68ac50476915fcbc5aabca6a5597e73a693dd8c224b6108b58eaed02e3db85927a1058fb7a0eb5f963e13d5e0cae1d0702f7c3bbc22df27e56908f14cfd26b172caf9461cae7bc08eb4336254e319131b819888b94a7c974b96db6a605d86c66975b90aa9aaae6a4e3931cb13065634046252d36cde9decba851849373abe1c4c032e745d86c8414a22aa490f5f8c9e387c2e4d4e37f551d85080fb41febe3ffc21d08b14e2ca8217a91b9ec0cb3928184658b07f9cd77f13ac69b7fe398e56b5e89595b285b6102cce794efb3cf0750ea558a9b1430271bf9e13381649cf78cadb899771f129c9399241c7b3b36a9bca09ac0dd95c84ba7e59c55f6f4f1dcee08a70f3a59a3d3e2932fcc6b7c54d2c665aae95d963fd349a2cde15729c23dae8808b5a</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-xray">      <input class="hbe hbe-input-field hbe-input-field-xray" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-xray" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-xray">æ‚¨å¥½, è¿™é‡Œéœ€è¦å¯†ç , å¾®ä¿¡å…¬ä¼—å·å­™èœèœå›å¤å…³é”®è¯chatgptè·å¾—å¯†ç .</span>      </label>      <svg class="hbe hbe-graphic hbe-graphic-xray" width="300%" height="100%" viewBox="0 0 1200 60" preserveAspectRatio="none">        <path d="M0,56.5c0,0,298.666,0,399.333,0C448.336,56.5,513.994,46,597,46c77.327,0,135,10.5,200.999,10.5c95.996,0,402.001,0,402.001,0"></path>        <path d="M0,2.5c0,0,298.666,0,399.333,0C448.336,2.5,513.994,13,597,13c77.327,0,135-10.5,200.999-10.5c95.996,0,402.001,0,402.001,0"></path>      </svg>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content:encoded>
      
      
      <category domain="https://atong.run/categories/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/">äººå·¥æ™ºèƒ½</category>
      
      <category domain="https://atong.run/categories/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80/">è‡ªç„¶è¯­è¨€</category>
      
      
      <category domain="https://atong.run/tags/ChatGPT/">ChatGPT</category>
      
      
      <comments>https://atong.run/posts/3439780086/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>çº¯ç”µåŠ¨æ±½è½¦simulinkæ•™ç¨‹</title>
      <link>https://atong.run/posts/1513554255/</link>
      <guid>https://atong.run/posts/1513554255/</guid>
      <pubDate>Tue, 28 Feb 2023 04:47:06 GMT</pubDate>
      
        
        
      <description>&lt;h1&gt;çº¯ç”µåŠ¨æ±½è½¦simulinkæ¨¡å‹&lt;/h1&gt;
&lt;h2 id=&quot;è¯¾ç¨‹ç®€ä»‹&quot;&gt;è¯¾ç¨‹ç®€ä»‹&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;https://img.shields.io/github/stars/suntong-1221/EV_Model.svg&quot; alt=&quot;Github sta</description>
        
      
      
      
      <content:encoded><![CDATA[<h1>çº¯ç”µåŠ¨æ±½è½¦simulinkæ¨¡å‹</h1><h2 id="è¯¾ç¨‹ç®€ä»‹">è¯¾ç¨‹ç®€ä»‹</h2><p><img src="https://img.shields.io/github/stars/suntong-1221/EV_Model.svg" alt="Github stars"><br><a href="https://ci.appveyor.com/project/suntong-1221/EV_Model"><img src="https://ci.appveyor.com/api/projects/status/sb279kxuv1be391g?svg=true" alt="Build status"></a></p><p>â€‹è¯¥æ¨¡å‹ä¸ºçº¯ç”µåŠ¨æ±½è½¦å•ç”µæœºæ•´è½¦æ¨¡å‹ğŸš—ï¼Œæ•´è½¦æ¨¡å‹å¯æ­£å¸¸ä»¿çœŸè¿è¡Œï¼Œä½†æ˜¯å…¶ä¸­å¯èƒ½å­˜åœ¨è¾ƒå¤§é—®é¢˜ï¼ŒåŒå­¦ä»¬åœ¨å­¦ä¹ çš„æ—¶å€™ä¸€å®šè¦è¾©è¯çš„çœ‹å¾…ï¼Œç„¶åé‡Œé¢ç¼ºå°‘å‡ ä¸ªè¡¨æ•°æ®ï¼Œè¿™ä¸ªå¹¶æ²¡æœ‰å…¬å¼€ï¼Œå› ä¸ºæ˜¯è¯¾é¢˜ç»„çš„èµ„æºã€‚</p><ul><li>å·²ç»æ·»åŠ äº†2018aç‰ˆæœ¬çš„æ¨¡å‹æ–‡ä»¶</li><li>Bç«™é“¾æ¥ï¼š<a href="https://www.bilibili.com/video/BV1cm4y1S7Rs?spm_id_from=333.999.0.0">https://www.bilibili.com/video/BV1cm4y1S7Rs?spm_id_from=333.999.0.0</a></li></ul><hr><h2 id="æ–°å¢å†…å®¹">æ–°å¢å†…å®¹</h2><p>â€‹å› ä¸ºæœ€åˆä¸Šä¼ æ¨¡å‹EV_v0.1ç‰ˆæœ¬ç¼ºå°‘éƒ¨åˆ†è¯¾é¢˜ç»„å†…éƒ¨æ•°æ®ï¼Œåº”åŒå­¦è¦æ±‚ï¼Œæ–°å¢EM_v0.2ç‰ˆæœ¬ï¼Œä¸‹è½½å¯æ­£å¸¸è¿è¡Œï¼Œç”µæœºæ˜¯éšä¾¿æ‰¾çš„ç¡•å£«è®ºæ–‡ç”µæœºé¢å®šåŠŸç‡ä¸º34kwï¼Œæœ€å¤§è½¬çŸ©130Nmï¼Œç„¶åæˆ‘éšä¾¿æŒ‰ç…§ç‰¹æ€§ç¼–çš„æ•°æ®ï¼Œç”µæœºæ•ˆç‡å›ºå®šä¸º0.95ï¼Œç”µæ± éƒ¨åˆ†ï¼Œç›´æ¥ç»™äº†å›ºå®šå†…é˜»å’Œå›ºå®šå•ä½“ç”µæ± ç”µå‹ã€‚</p><p><font color=Red>æ³¨æ„äº‹é¡¹</font>:underage:</p><ul><li>æ¨¡å‹å¤§è‡´ç¬¦åˆç”µåŠ¨æ±½è½¦ç‰¹æ€§ï¼Œä½†æ˜¯æ•°æ®åŠå…¶ä¸å¯ä¿¡</li><li>ç®€å•å­¦ä¹ ä½¿ç”¨ï¼Œè¾©è¯çœ‹å¾…</li></ul><hr><h2 id="è¯¾ç¨‹åˆ†èŠ‚">è¯¾ç¨‹åˆ†èŠ‚</h2><ol><li><a href="https://www.bilibili.com/video/BV1cm4y1S7Rs/?spm_id_from=333.788&amp;vd_source=df2f7337299806c5a1ed5a5f5b4ffd1d">çº¯ç”µåŠ¨æ±½è½¦simulinkå»ºæ¨¡ä»¿çœŸ-æ¡†æ¶é€»è¾‘</a></li><li><a href="https://www.bilibili.com/video/BV1a3411Y7dg/?spm_id_from=333.788&amp;vd_source=df2f7337299806c5a1ed5a5f5b4ffd1d">çº¯ç”µåŠ¨æ±½è½¦simulinkå»ºæ¨¡ä»¿çœŸ-é©¾é©¶å‘˜æ¨¡å‹</a></li><li><a href="https://www.bilibili.com/video/BV1GT4y1y7TU/?spm_id_from=333.788&amp;vd_source=df2f7337299806c5a1ed5a5f5b4ffd1d">çº¯ç”µåŠ¨æ±½è½¦simulinkå»ºæ¨¡ä»¿çœŸ-ç”µæ± æ¨¡å‹</a></li><li><a href="https://www.bilibili.com/video/BV18L4y1s7W2/?spm_id_from=333.788&amp;vd_source=df2f7337299806c5a1ed5a5f5b4ffd1d">çº¯ç”µåŠ¨æ±½è½¦simulinkå»ºæ¨¡ä»¿çœŸ-æ§åˆ¶æ¨¡å‹</a></li><li><a href="https://www.bilibili.com/video/BV1Yq4y1b7PB/?spm_id_from=333.788&amp;vd_source=df2f7337299806c5a1ed5a5f5b4ffd1d">çº¯ç”µåŠ¨æ±½è½¦simulinkå»ºæ¨¡ä»¿çœŸ-ç”µæœºæ¨¡å‹</a></li><li><a href="https://www.bilibili.com/video/BV1kb4y177MD/?spm_id_from=333.788&amp;vd_source=df2f7337299806c5a1ed5a5f5b4ffd1d">çº¯ç”µåŠ¨æ±½è½¦simulinkå»ºæ¨¡ä»¿çœŸ-è½¦èº«æ¨¡å‹</a></li><li><a href="https://www.bilibili.com/video/BV1r5411o7Rg/?spm_id_from=333.788&amp;vd_source=df2f7337299806c5a1ed5a5f5b4ffd1d">çº¯ç”µåŠ¨æ±½è½¦simulinkå»ºæ¨¡ä»¿çœŸ-ä»¿çœŸä¸æ¬§æ‹‰ç®—æ³•</a></li></ol>]]></content:encoded>
      
      
      <category domain="https://atong.run/categories/%E5%BC%80%E6%BA%90%E8%AF%BE%E7%A8%8B/">å¼€æºè¯¾ç¨‹</category>
      
      <category domain="https://atong.run/categories/%E5%BC%80%E6%BA%90%E8%AF%BE%E7%A8%8B/simulink/">simulink</category>
      
      
      
      <comments>https://atong.run/posts/1513554255/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>pythonèœé¸¡æ•™ç¨‹</title>
      <link>https://atong.run/posts/2838110349/</link>
      <guid>https://atong.run/posts/2838110349/</guid>
      <pubDate>Tue, 28 Feb 2023 04:46:48 GMT</pubDate>
      
        
        
      <description>&lt;h1&gt;pythonèœé¸¡æ•™ç¨‹&lt;/h1&gt;
&lt;h2 id=&quot;è¯¾ç¨‹ç®€ä»‹&quot;&gt;è¯¾ç¨‹ç®€ä»‹&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;è´¹æ›¼å­¦ä¹ æ³•æ˜¯æ¯”è¾ƒæœ‰åçš„ä¸€ç§å­¦ä¹ æ–¹å¼ï¼Œæ ¸å¿ƒè¦ä¹‰æ˜¯é€šè¿‡å¤è¿°æ¦‚å¿µå¹¶åé¦ˆç»“æœæ¥åŠ å¼ºè®°å¿†ï¼Œå®ƒæ˜¯ç¬¦åˆå¤§è„‘çš„è®¤çŸ¥è§„å¾‹ï¼Œä»æ··ä¹±èµ°å‘æœ‰åºçš„è¿‡ç¨‹ï¼Œä»è¢«åŠ¨è®°å¿†èµ°å‘ä¸»åŠ¨ç†è§£å¹¶é˜è¿°ã€‚è¿™ä¹ˆ</description>
        
      
      
      
      <content:encoded><![CDATA[<h1>pythonèœé¸¡æ•™ç¨‹</h1><h2 id="è¯¾ç¨‹ç®€ä»‹">è¯¾ç¨‹ç®€ä»‹</h2><blockquote><p>è´¹æ›¼å­¦ä¹ æ³•æ˜¯æ¯”è¾ƒæœ‰åçš„ä¸€ç§å­¦ä¹ æ–¹å¼ï¼Œæ ¸å¿ƒè¦ä¹‰æ˜¯é€šè¿‡å¤è¿°æ¦‚å¿µå¹¶åé¦ˆç»“æœæ¥åŠ å¼ºè®°å¿†ï¼Œå®ƒæ˜¯ç¬¦åˆå¤§è„‘çš„è®¤çŸ¥è§„å¾‹ï¼Œä»æ··ä¹±èµ°å‘æœ‰åºçš„è¿‡ç¨‹ï¼Œä»è¢«åŠ¨è®°å¿†èµ°å‘ä¸»åŠ¨ç†è§£å¹¶é˜è¿°ã€‚è¿™ä¹ˆæ£’çš„å­¦ä¹ æ–¹å¼å½“ç„¶è¦å°è¯•å°è¯•ï¼Œé€šè¿‡è¿™ç§æ–¹å¼æˆ‘ä¹Ÿå°è¯•å­¦å­¦python</p></blockquote><p>è¯¾ç¨‹ä¾æ‰˜äºå¤§ä½¬æ–‡å­—ç‰ˆæ•™ç¨‹<a href="https://www.liaoxuefeng.com/wiki/1016959663602400">å»–é›ªå³°pythonæ•™ç¨‹</a>è¿›è¡Œç†è§£ä¸è®²è¿°</p><h2 id="è¯¾ç¨‹é“¾æ¥">è¯¾ç¨‹é“¾æ¥</h2><p><a href="https://www.ixigua.com/7173635950831108620?logTag=51f64d219c69d66c8201">ç¬¬ä¸€èŠ‚ã€è¾“å…¥å’Œè¾“å‡º</a></p><p><a href="https://www.ixigua.com/7174049005603979791?logTag=622639136a3e74362eb4">ç¬¬äºŒèŠ‚ã€æ•°æ®ç±»å‹å’Œå˜é‡</a></p><p><a href="https://www.ixigua.com/7178820918473392655?logTag=ac50f7d3ba276998ee50">ç¬¬ä¸‰èŠ‚ã€å­—ç¬¦ä¸²å’Œç¼–ç </a></p><p><a href="https://www.ixigua.com/7181108669298410024?logTag=9135f17cb2c13d20b8e2">ç¬¬å››èŠ‚ã€ä½¿ç”¨listå’Œtuple</a></p><p><a href="https://www.ixigua.com/7181418828872876547?logTag=9889661aec1751e1989c">ç¬¬äº”èŠ‚ã€æ¡ä»¶åˆ¤æ–­å’Œå¾ªç¯</a></p><p><a href="https://www.ixigua.com/7190390094074184203?logTag=66a3f6d9d08eddd09840">ç¬¬å…­èŠ‚ã€ä½¿ç”¨dictå’Œset</a></p><p><a href="https://www.ixigua.com/7194312039769211396?logTag=9217a796a89d2de0e0f3">ç¬¬ä¸ƒèŠ‚ã€è°ƒç”¨å‡½æ•°</a></p>]]></content:encoded>
      
      
      <category domain="https://atong.run/categories/%E5%BC%80%E6%BA%90%E8%AF%BE%E7%A8%8B/">å¼€æºè¯¾ç¨‹</category>
      
      <category domain="https://atong.run/categories/%E5%BC%80%E6%BA%90%E8%AF%BE%E7%A8%8B/Python/">Python</category>
      
      
      
      <comments>https://atong.run/posts/2838110349/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>9ã€é«˜å¹¶å‘å†…å­˜æ± -æ€§èƒ½æµ‹è¯•åŠä¼˜åŒ–</title>
      <link>https://atong.run/posts/1573212312/</link>
      <guid>https://atong.run/posts/1573212312/</guid>
      <pubDate>Fri, 17 Feb 2023 08:45:32 GMT</pubDate>
      
        
        
      <description>&lt;h1&gt;å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯¹æ¯”mallocæµ‹è¯•&lt;/h1&gt;
&lt;h2 id=&quot;æµ‹è¯•ä»£ç &quot;&gt;æµ‹è¯•ä»£ç &lt;/h2&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/spa</description>
        
      
      
      
      <content:encoded><![CDATA[<h1>å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯¹æ¯”mallocæµ‹è¯•</h1><h2 id="æµ‹è¯•ä»£ç ">æµ‹è¯•ä»£ç </h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;ConcurrentAlloc.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ntimes ä¸€è½®ç”³è¯·å’Œé‡Šæ”¾å†…å­˜çš„æ¬¡æ•°</span></span><br><span class="line"><span class="comment">// rounds è½®æ¬¡</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BenchmarkMalloc</span><span class="params">(<span class="type">size_t</span> ntimes, <span class="type">size_t</span> nworks, <span class="type">size_t</span> rounds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="function">std::vector&lt;std::thread&gt; <span class="title">vthread</span><span class="params">(nworks)</span></span>;</span><br><span class="line">std::atomic&lt;<span class="type">size_t</span>&gt; malloc_costtime = <span class="number">0</span>;</span><br><span class="line">std::atomic&lt;<span class="type">size_t</span>&gt; free_costtime = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> k = <span class="number">0</span>; k &lt; nworks; ++k)</span><br><span class="line">&#123;</span><br><span class="line">vthread[k] = std::<span class="built_in">thread</span>([&amp;, k]() &#123;</span><br><span class="line">std::vector&lt;<span class="type">void</span>*&gt; v;</span><br><span class="line">v.<span class="built_in">reserve</span>(ntimes);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; rounds; ++j)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">size_t</span> begin1 = <span class="built_in">clock</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; ntimes; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//v.push_back(malloc(16));</span></span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="built_in">malloc</span>((<span class="number">16</span> + i) % <span class="number">8192</span> + <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> end1 = <span class="built_in">clock</span>();</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> begin2 = <span class="built_in">clock</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; ntimes; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">free</span>(v[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> end2 = <span class="built_in">clock</span>();</span><br><span class="line">v.<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line">malloc_costtime += (end1 - begin1);</span><br><span class="line">free_costtime += (end2 - begin2);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; t : vthread)</span><br><span class="line">&#123;</span><br><span class="line">t.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cout &lt;&lt; nworks &lt;&lt; <span class="string">&quot;ä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œ&quot;</span> &lt;&lt; rounds &lt;&lt; <span class="string">&quot;è½®æ¬¡ï¼Œæ¯è½®æ¬¡malloc &quot;</span> &lt;&lt; ntimes &lt;&lt; <span class="string">&quot;æ¬¡ï¼šèŠ±è´¹ï¼š&quot;</span> &lt;&lt; malloc_costtime &lt;&lt; <span class="string">&quot; ms&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cout &lt;&lt; nworks &lt;&lt; <span class="string">&quot;ä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œ&quot;</span> &lt;&lt; rounds &lt;&lt; <span class="string">&quot;è½®æ¬¡ï¼Œæ¯è½®æ¬¡free &quot;</span> &lt;&lt; ntimes &lt;&lt; <span class="string">&quot;æ¬¡ï¼šèŠ±è´¹ï¼š&quot;</span> &lt;&lt; free_costtime &lt;&lt; <span class="string">&quot; ms&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; nworks &lt;&lt; <span class="string">&quot;ä¸ªçº¿ç¨‹å¹¶å‘malloc&amp;free&quot;</span> &lt;&lt; nworks * rounds * ntimes &lt;&lt; <span class="string">&quot;æ€»è®¡èŠ±è´¹ï¼š&quot;</span> &lt;&lt; malloc_costtime + free_costtime &lt;&lt; <span class="string">&quot; ms&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å•è½®æ¬¡ç”³è¯·é‡Šæ”¾æ¬¡æ•° çº¿ç¨‹æ•° è½®æ¬¡</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BenchmarkConcurrentMalloc</span><span class="params">(<span class="type">size_t</span> ntimes, <span class="type">size_t</span> nworks, <span class="type">size_t</span> rounds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="function">std::vector&lt;std::thread&gt; <span class="title">vthread</span><span class="params">(nworks)</span></span>;</span><br><span class="line">std::atomic&lt;<span class="type">size_t</span>&gt; malloc_costtime = <span class="number">0</span>;</span><br><span class="line">std::atomic&lt;<span class="type">size_t</span>&gt; free_costtime = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> k = <span class="number">0</span>; k &lt; nworks; ++k)</span><br><span class="line">&#123;</span><br><span class="line">vthread[k] = std::<span class="built_in">thread</span>([&amp;]() &#123;</span><br><span class="line">std::vector&lt;<span class="type">void</span>*&gt; v;</span><br><span class="line">v.<span class="built_in">reserve</span>(ntimes);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; rounds; ++j)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">size_t</span> begin1 = <span class="built_in">clock</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; ntimes; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//v.push_back(ConcurrentAlloc(16));</span></span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="built_in">ConcurrentAlloc</span>((<span class="number">16</span> + i) % <span class="number">8192</span> + <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> end1 = <span class="built_in">clock</span>();</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> begin2 = <span class="built_in">clock</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; ntimes; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">ConcurrentFree</span>(v[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> end2 = <span class="built_in">clock</span>();</span><br><span class="line">v.<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line">malloc_costtime += (end1 - begin1);</span><br><span class="line">free_costtime += (end2 - begin2);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; t : vthread)</span><br><span class="line">&#123;</span><br><span class="line">t.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cout &lt;&lt; nworks &lt;&lt; <span class="string">&quot;ä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œ&quot;</span> &lt;&lt; rounds &lt;&lt; <span class="string">&quot;è½®æ¬¡ï¼Œæ¯è½®æ¬¡concurrent alloc &quot;</span> &lt;&lt; ntimes &lt;&lt; <span class="string">&quot;æ¬¡ï¼šèŠ±è´¹ï¼š&quot;</span> &lt;&lt; malloc_costtime &lt;&lt; <span class="string">&quot; ms&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; nworks &lt;&lt; <span class="string">&quot;ä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œ&quot;</span> &lt;&lt; rounds &lt;&lt; <span class="string">&quot;è½®æ¬¡ï¼Œæ¯è½®æ¬¡concurrent dealloc &quot;</span> &lt;&lt; ntimes &lt;&lt; <span class="string">&quot;æ¬¡ï¼šèŠ±è´¹ï¼š&quot;</span> &lt;&lt; free_costtime &lt;&lt; <span class="string">&quot; ms&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; nworks &lt;&lt; <span class="string">&quot;ä¸ªçº¿ç¨‹å¹¶å‘concurrent alloc&amp;dealloc&quot;</span> &lt;&lt; nworks * rounds * ntimes &lt;&lt; <span class="string">&quot;æ€»è®¡èŠ±è´¹ï¼š&quot;</span> &lt;&lt; malloc_costtime + free_costtime &lt;&lt; <span class="string">&quot; ms&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">size_t</span> n = <span class="number">10000</span>;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;==========================================================&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="built_in">BenchmarkConcurrentMalloc</span>(n, <span class="number">4</span>, <span class="number">10</span>);</span><br><span class="line">cout &lt;&lt; endl &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line"><span class="built_in">BenchmarkMalloc</span>(n, <span class="number">4</span>, <span class="number">10</span>);</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;==========================================================&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç”³è¯·é‡Šæ”¾å›ºå®šå†…å­˜å¤§å°">ç”³è¯·é‡Šæ”¾å›ºå®šå†…å­˜å¤§å°</h2><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302171300120.png" alt="image.png"></p><h2 id="ç”³è¯·é‡Šæ”¾ä¸åŒå†…å­˜å¤§å°">ç”³è¯·é‡Šæ”¾ä¸åŒå†…å­˜å¤§å°</h2><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302171303359.png" alt="image.png"></p><h1>æ€§èƒ½ç“¶é¢ˆåˆ†æ</h1><blockquote><p>ä¸Šè¿°æµ‹è¯•å‘ç°ï¼Œæˆ‘ä»¬çš„å†…å­˜æ± æ¯”mallocè¿˜æ˜¯å·®ä¸€äº›çš„ï¼Œä½†æ˜¯ä¸å¤§å®¹æ˜“çŸ¥é“åˆ°åº•æ˜¯ä»£ç çš„å“ªä¸€ä¸ªéƒ¨åˆ†æ¶ˆè€—çš„æ€§èƒ½è¾ƒå¤šï¼Œä¸çŸ¥é“æ€§èƒ½çš„ç“¶é¢ˆåœ¨å“ªé‡Œï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·</p></blockquote><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302171413680.png" alt="image.png"></p><p>æ‰“å¼€æ€§èƒ½æ¢æŸ¥å™¨ï¼Œå¯ç”¨å·¥å…·ç±»ï¼Œæ£€æµ‹é¡¹æ‰“ä¸Šå¯¹å·</p><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302171414904.png" alt="image.png"></p><p>ç‚¹å‡»å¼€å§‹</p><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302171430934.png" alt="image.png"></p><p>å¯ä»¥å‘ç°MapObjectToSpanæ‰€èŠ±è´¹æ—¶é—´éå¸¸é•¿ï¼Œå› ä¸ºæ¶‰åŠåˆ°é”çš„ç«äº‰é—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•è¿›è¡Œä¼˜åŒ–å‘¢ï¼Ÿ</p><h1>åŸºæ•°æ ‘ä¼˜åŒ–</h1><blockquote><p>è¿™é‡Œä½¿ç”¨åŸºæ•°æ ‘è¿›è¡Œä¼˜åŒ–ï¼ŒåŸºæ•°æ ‘å®é™…æ˜¯ä¸€ä¸ªåˆ†å±‚çš„å“ˆå¸Œè¡¨ï¼Œæ ¹æ®æ‰€åˆ†å±‚æ•°ï¼Œå¯ä»¥åˆ†ä¸ºå•å±‚åŸºæ•°æ ‘ã€äºŒå±‚åŸºæ•°æ ‘ã€ä¸‰å±‚åŸºæ•°æ ‘</p></blockquote><h2 id="å•å±‚åŸºæ•°æ ‘">å•å±‚åŸºæ•°æ ‘</h2><blockquote><p>å•å±‚åŸºæ•°æ ‘ä½¿ç”¨çš„æ˜¯ç›´æ¥å®šå€æ³•ï¼Œåœ¨32ä½å¹³å°ä¸‹ï¼Œæœ€å¤šåˆ†æˆ2^32/2^13æ¬¡æ–¹ä¸ªé¡µï¼Œæˆ‘ä»¬ç›´æ¥å¼€2^(31-13)æ¬¡æ–¹å¤§å°çš„æ•°ç»„</p></blockquote><p>è¿™è¿™é‡Œå¯ä»¥ç”¨éç±»å‹æ¨¡æ¿å‚æ•°ï¼Œå°†æ¬¡æ–¹ä¼ å…¥ï¼Œ1&lt;&lt; BITS å°±æ˜¯2çš„BITSæ¬¡æ–¹ã€‚ç›´æ¥å¼€è¿™ä¹ˆé•¿çš„æ•°ç»„</p><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302171521406.png" alt="image.png"></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="type">int</span> BITS&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TCMalloc_PageMap1</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> LENGTH = <span class="number">1</span> &lt;&lt; BITS;</span><br><span class="line"><span class="type">void</span>** array_;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uintptr_t</span> Number;</span><br><span class="line"></span><br><span class="line"><span class="comment">//explicit TCMalloc_PageMap1(void* (*allocator)(size_t)) &#123;</span></span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">TCMalloc_PageMap1</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//array_ = reinterpret_cast&lt;void**&gt;((*allocator)(sizeof(void*) &lt;&lt; BITS));</span></span><br><span class="line"><span class="type">size_t</span> size = <span class="built_in">sizeof</span>(<span class="type">void</span>*) &lt;&lt; BITS;</span><br><span class="line"><span class="type">size_t</span> alignSize = SizeClass::_RoundUp(size, <span class="number">1</span> &lt;&lt; PAGE_SHIFT);</span><br><span class="line">array_ = (<span class="type">void</span>**)<span class="built_in">SystemAlloc</span>(alignSize &gt;&gt; PAGE_SHIFT);</span><br><span class="line"><span class="built_in">memset</span>(array_, <span class="number">0</span>, <span class="built_in">sizeof</span>(<span class="type">void</span>*) &lt;&lt; BITS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Return the current value for KEY.  Returns NULL if not yet set,</span></span><br><span class="line"><span class="comment">// or if k is out of range.</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">get</span><span class="params">(Number k)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> ((k &gt;&gt; BITS) &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> array_[k];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// REQUIRES &quot;k&quot; is in range &quot;[0,2^BITS-1]&quot;.</span></span><br><span class="line"><span class="comment">// REQUIRES &quot;k&quot; has been ensured before.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Sets the value &#x27;v&#x27; for key &#x27;k&#x27;.</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">set</span><span class="params">(Number k, <span class="type">void</span>* v)</span> </span>&#123;</span><br><span class="line">array_[k] = v;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="äºŒå±‚åŸºæ•°æ ‘">äºŒå±‚åŸºæ•°æ ‘</h2><blockquote><p>å‡è®¾åŒæ ·åœ¨32ä½å¹³å°ä¸‹ï¼Œæœ€å¤šåˆ†æˆ2^32/2^13  = 2^19æ¬¡æ–¹ä¸ªé¡µï¼Œæœ€å¤šç”¨19ä¸ªæ¯”ç‰¹ä½å¯ä»¥æ ‡è¯†ï¼Œç”¨äºŒå±‚å¾—åŸºæ•°æ ‘ï¼Œç¬¬ä¸€å±‚åªç”¨5ä¸ªæ¯”ç‰¹ä½ï¼Œåšç›´æ¥å®šå€ï¼Œå¯¹åº”çš„ä¸‹æ ‡å­˜çš„å…ƒç´ æ˜¯ void* values[LEAF_LENGTH]ï¼Œå‰©ä¸‹çš„14ä½å¯ä»¥æ€»å…±æ˜ å°„ length = 1&lt;&lt;14ä¸ªæ•°æ®</p></blockquote><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302171526874.png" alt="image.png"></p><p>ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Two-level radix tree</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="type">int</span> BITS&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TCMalloc_PageMap2</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="comment">// Put 32 entries in the root and (2^BITS)/32 entries in each leaf.</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> ROOT_BITS = <span class="number">5</span>; <span class="comment">//ç¬¬ä¸€å±‚å¯¹åº”é¡µå·çš„å‰5ä¸ªæ¯”ç‰¹ä½</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> ROOT_LENGTH = <span class="number">1</span> &lt;&lt; ROOT_BITS; <span class="comment">//ç¬¬ä¸€å±‚å­˜å‚¨å…ƒç´ çš„ä¸ªæ•° 2^5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> LEAF_BITS = BITS - ROOT_BITS;<span class="comment">//ç¬¬äºŒå±‚å¯¹åº”é¡µå·çš„å…¶ä½™æ¯”ç‰¹ä½ 19-5=14</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> LEAF_LENGTH = <span class="number">1</span> &lt;&lt; LEAF_BITS; <span class="comment">//ç¬¬äºŒå±‚å­˜å‚¨å…ƒç´ çš„ä¸ªæ•° 2^14</span></span><br><span class="line"><span class="comment">// Leaf node</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Leaf</span> &#123;</span><br><span class="line"><span class="type">void</span>* values[LEAF_LENGTH];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Leaf* root_[ROOT_LENGTH];             <span class="comment">// Pointers to 32 child nodes</span></span><br><span class="line"><span class="type">void</span>* (*allocator_)(<span class="type">size_t</span>);          <span class="comment">// Memory allocator</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uintptr_t</span> Number;</span><br><span class="line"></span><br><span class="line"><span class="comment">//explicit TCMalloc_PageMap2(void* (*allocator)(size_t)) &#123;</span></span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">TCMalloc_PageMap2</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//allocator_ = allocator;</span></span><br><span class="line"><span class="built_in">memset</span>(root_, <span class="number">0</span>, <span class="built_in">sizeof</span>(root_));</span><br><span class="line"></span><br><span class="line"><span class="built_in">PreallocateMoreMemory</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">get</span><span class="params">(Number k)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line"><span class="type">const</span> Number i1 = k &gt;&gt; LEAF_BITS;  <span class="comment">// å³ç§»14ä½ï¼Œå¾—åˆ°å‰5ä½</span></span><br><span class="line"><span class="type">const</span> Number i2 = k &amp; (LEAF_LENGTH - <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> ((k &gt;&gt; BITS) &gt; <span class="number">0</span> || root_[i1] == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> root_[i1]-&gt;values[i2];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">set</span><span class="params">(Number k, <span class="type">void</span>* v)</span> </span>&#123;</span><br><span class="line"><span class="type">const</span> Number i1 = k &gt;&gt; LEAF_BITS;</span><br><span class="line"><span class="comment">// 1000 0000 0000 000-1 = 0111 1111 1111 11</span></span><br><span class="line"><span class="comment">// ç›¸ä¸è·å¾—å14ä½</span></span><br><span class="line"><span class="type">const</span> Number i2 = k &amp; (LEAF_LENGTH - <span class="number">1</span>); </span><br><span class="line"><span class="built_in">ASSERT</span>(i1 &lt; ROOT_LENGTH);</span><br><span class="line">root_[i1]-&gt;values[i2] = v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¡®ä¿æ˜ å°„[start ï¼Œ start+n-1]é¡µå·çš„ç©ºé—´æ˜¯å¼€å¥½çš„</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Ensure</span><span class="params">(Number start, <span class="type">size_t</span> n)</span> </span>&#123;</span><br><span class="line"><span class="keyword">for</span> (Number key = start; key &lt;= start + n - <span class="number">1</span>;) &#123;</span><br><span class="line"><span class="type">const</span> Number i1 = key &gt;&gt; LEAF_BITS;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check for overflow</span></span><br><span class="line"><span class="keyword">if</span> (i1 &gt;= ROOT_LENGTH)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Make 2nd level node if necessary</span></span><br><span class="line"><span class="keyword">if</span> (root_[i1] == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="comment">//Leaf* leaf = reinterpret_cast&lt;Leaf*&gt;((*allocator_)(sizeof(Leaf)));</span></span><br><span class="line"><span class="comment">//if (leaf == NULL) return false;</span></span><br><span class="line"><span class="type">static</span> ObjectPool&lt;Leaf&gt;leafPool;</span><br><span class="line">Leaf* leaf = (Leaf*)leafPool.<span class="built_in">New</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(leaf, <span class="number">0</span>, <span class="built_in">sizeof</span>(*leaf));</span><br><span class="line">root_[i1] = leaf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Advance key past whatever is covered by this leaf node</span></span><br><span class="line">key = ((key &gt;&gt; LEAF_BITS) + <span class="number">1</span>) &lt;&lt; LEAF_BITS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PreallocateMoreMemory</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// å°†ç¬¬äºŒå±‚å…¨éƒ¨çš„ç©ºé—´éƒ½å¼€å¥½</span></span><br><span class="line"><span class="built_in">Ensure</span>(<span class="number">0</span>, <span class="number">1</span> &lt;&lt; BITS);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨32ä½å¹³å°ä¸‹ï¼Œç¬¬ä¸€å±‚æ•°ç»„å ï¼Œ2^5* 4=2^7å­—èŠ‚ï¼Œç¬¬äºŒå±‚æœ€å¤šæœ‰2^5^2^14^4=2^21=2Mï¼Œæ¶ˆè€—ä¹Ÿä¸å¤§ï¼Œå¯ä»¥ç›´æ¥å…¨å¼€å‡ºæ¥</p></blockquote><h2 id="ä¸‰å±‚åŸºæ•°æ ‘">ä¸‰å±‚åŸºæ•°æ ‘</h2><blockquote><p>64ä½å¹³å°ä¸‹ï¼Œå…¬å…±æœ‰2^64/2^13=2^51ä¸ªé¡µï¼Œä¸€å±‚åŸºæ•°æ ‘è‚¯å®šä¸è¡Œï¼ŒäºŒå±‚é¡µä¸å¤§è¡Œï¼Œç”¨ä¸‰å±‚åŸºæ•°æ ‘ï¼Œä¸‰å±‚åŸºæ•°æ ‘å°±æ˜¯å°†å­˜å‚¨é¡µå·çš„æ¯”ç‰¹ä½åˆ†ä¸‰æ¬¡æ˜ å°„</p></blockquote><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302171607278.png" alt="image.png"></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Three-level radix tree</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="type">int</span> BITS&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TCMalloc_PageMap3</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> INTERIOR_BITS = (BITS + <span class="number">2</span>) / <span class="number">3</span>;       <span class="comment">//ç¬¬ä¸€ã€äºŒå±‚å¯¹åº”é¡µå·çš„æ¯”ç‰¹ä½ä¸ªæ•°</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> INTERIOR_LENGTH = <span class="number">1</span> &lt;&lt; INTERIOR_BITS; <span class="comment">//ç¬¬ä¸€ã€äºŒå±‚å­˜å‚¨å…ƒç´ çš„ä¸ªæ•°</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> LEAF_BITS = BITS - <span class="number">2</span> * INTERIOR_BITS; <span class="comment">//ç¬¬ä¸‰å±‚å¯¹åº”é¡µå·çš„æ¯”ç‰¹ä½ä¸ªæ•°</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> LEAF_LENGTH = <span class="number">1</span> &lt;&lt; LEAF_BITS;         <span class="comment">//ç¬¬ä¸‰å±‚å­˜å‚¨å…ƒç´ çš„ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span></span><br><span class="line">&#123;</span><br><span class="line">Node* ptrs[INTERIOR_LENGTH];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Leaf</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">void</span>* values[LEAF_LENGTH];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">Node* <span class="title">NewNode</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">static</span> ObjectPool&lt;Node&gt; nodePool;</span><br><span class="line">Node* result = nodePool.<span class="built_in">New</span>();</span><br><span class="line"><span class="keyword">if</span> (result != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">memset</span>(result, <span class="number">0</span>, <span class="built_in">sizeof</span>(*result));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">Node* root_;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uintptr_t</span> Number;</span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">TCMalloc_PageMap3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">root_ = <span class="built_in">NewNode</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">get</span><span class="params">(Number k)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">const</span> Number i1 = k &gt;&gt; (LEAF_BITS + INTERIOR_BITS);         <span class="comment">//ç¬¬ä¸€å±‚å¯¹åº”çš„ä¸‹æ ‡</span></span><br><span class="line"><span class="type">const</span> Number i2 = (k &gt;&gt; LEAF_BITS) &amp; (INTERIOR_LENGTH - <span class="number">1</span>); <span class="comment">//ç¬¬äºŒå±‚å¯¹åº”çš„ä¸‹æ ‡</span></span><br><span class="line"><span class="type">const</span> Number i3 = k &amp; (LEAF_LENGTH - <span class="number">1</span>);                    <span class="comment">//ç¬¬ä¸‰å±‚å¯¹åº”çš„ä¸‹æ ‡</span></span><br><span class="line"><span class="comment">//é¡µå·è¶…å‡ºèŒƒå›´ï¼Œæˆ–æ˜ å°„è¯¥é¡µå·çš„ç©ºé—´æœªå¼€è¾Ÿ</span></span><br><span class="line"><span class="keyword">if</span> ((k &gt;&gt; BITS) &gt; <span class="number">0</span> || root_-&gt;ptrs[i1] == <span class="literal">NULL</span> || root_-&gt;ptrs[i1]-&gt;ptrs[i2] == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">reinterpret_cast</span>&lt;Leaf*&gt;(root_-&gt;ptrs[i1]-&gt;ptrs[i2])-&gt;values[i3]; <span class="comment">//è¿”å›è¯¥é¡µå·å¯¹åº”spançš„æŒ‡é’ˆ</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">set</span><span class="params">(Number k, <span class="type">void</span>* v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">assert</span>(k &gt;&gt; BITS == <span class="number">0</span>);</span><br><span class="line"><span class="type">const</span> Number i1 = k &gt;&gt; (LEAF_BITS + INTERIOR_BITS);         <span class="comment">//ç¬¬ä¸€å±‚å¯¹åº”çš„ä¸‹æ ‡</span></span><br><span class="line"><span class="type">const</span> Number i2 = (k &gt;&gt; LEAF_BITS) &amp; (INTERIOR_LENGTH - <span class="number">1</span>); <span class="comment">//ç¬¬äºŒå±‚å¯¹åº”çš„ä¸‹æ ‡</span></span><br><span class="line"><span class="type">const</span> Number i3 = k &amp; (LEAF_LENGTH - <span class="number">1</span>);                    <span class="comment">//ç¬¬ä¸‰å±‚å¯¹åº”çš„ä¸‹æ ‡</span></span><br><span class="line"><span class="built_in">Ensure</span>(k, <span class="number">1</span>); <span class="comment">//ç¡®ä¿æ˜ å°„ç¬¬ké¡µé¡µå·çš„ç©ºé—´æ˜¯å¼€è¾Ÿå¥½äº†çš„</span></span><br><span class="line"><span class="built_in">reinterpret_cast</span>&lt;Leaf*&gt;(root_-&gt;ptrs[i1]-&gt;ptrs[i2])-&gt;values[i3] = v; <span class="comment">//å»ºç«‹è¯¥é¡µå·ä¸å¯¹åº”spançš„æ˜ å°„</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç¡®ä¿æ˜ å°„[start,start+n-1]é¡µå·çš„ç©ºé—´æ˜¯å¼€è¾Ÿå¥½äº†çš„</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Ensure</span><span class="params">(Number start, <span class="type">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">for</span> (Number key = start; key &lt;= start + n - <span class="number">1</span>;)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> Number i1 = key &gt;&gt; (LEAF_BITS + INTERIOR_BITS);         <span class="comment">//ç¬¬ä¸€å±‚å¯¹åº”çš„ä¸‹æ ‡</span></span><br><span class="line"><span class="type">const</span> Number i2 = (key &gt;&gt; LEAF_BITS) &amp; (INTERIOR_LENGTH - <span class="number">1</span>); <span class="comment">//ç¬¬äºŒå±‚å¯¹åº”çš„ä¸‹æ ‡</span></span><br><span class="line"><span class="keyword">if</span> (i1 &gt;= INTERIOR_LENGTH || i2 &gt;= INTERIOR_LENGTH) <span class="comment">//ä¸‹æ ‡å€¼è¶…å‡ºèŒƒå›´</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span> (root_-&gt;ptrs[i1] == <span class="literal">NULL</span>) <span class="comment">//ç¬¬ä¸€å±‚i1ä¸‹æ ‡æŒ‡å‘çš„ç©ºé—´æœªå¼€è¾Ÿ</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//å¼€è¾Ÿå¯¹åº”ç©ºé—´</span></span><br><span class="line">Node* n = <span class="built_in">NewNode</span>();</span><br><span class="line"><span class="keyword">if</span> (n == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">root_-&gt;ptrs[i1] = n;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (root_-&gt;ptrs[i1]-&gt;ptrs[i2] == <span class="literal">NULL</span>) <span class="comment">//ç¬¬äºŒå±‚i2ä¸‹æ ‡æŒ‡å‘çš„ç©ºé—´æœªå¼€è¾Ÿ</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//å¼€è¾Ÿå¯¹åº”ç©ºé—´</span></span><br><span class="line"><span class="type">static</span> ObjectPool&lt;Leaf&gt; leafPool;</span><br><span class="line">Leaf* leaf = leafPool.<span class="built_in">New</span>();</span><br><span class="line"><span class="keyword">if</span> (leaf == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="built_in">memset</span>(leaf, <span class="number">0</span>, <span class="built_in">sizeof</span>(*leaf));</span><br><span class="line">root_-&gt;ptrs[i1]-&gt;ptrs[i2] = <span class="built_in">reinterpret_cast</span>&lt;Node*&gt;(leaf);</span><br><span class="line">&#125;</span><br><span class="line">key = ((key &gt;&gt; LEAF_BITS) + <span class="number">1</span>) &lt;&lt; LEAF_BITS; <span class="comment">//ç»§ç»­åç»­æ£€æŸ¥</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PreallocateMoreMemory</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>å½“éœ€è¦å»ºç«‹æŸä¸€é¡µå·çš„æ˜ å°„å…³ç³»æ—¶ï¼Œå…ˆç¡®ä¿å­˜å‚¨è¯¥é¡µæ˜ å°„çš„æ•°ç»„ç©ºé—´æ˜¯å¼€å¥½çš„ï¼Œè°ƒç”¨Ensureå‡½æ•°ï¼Œå¦‚æœæ²¡å¼€å¥½ï¼Œå°±å¼€è¾Ÿå¯¹åº”çš„ç©ºé—´</p></blockquote><h2 id="ä½¿ç”¨åŸºæ•°æ ‘ä¼˜åŒ–">ä½¿ç”¨åŸºæ•°æ ‘ä¼˜åŒ–</h2><blockquote><p>æˆ‘ä»¬åœ¨32ä½å¹³å°ä¸‹æµ‹è¯•ï¼Œç›´æ¥ä½¿ç”¨ä¸€å±‚åŸºæ•°æ ‘å³å¯å°†unordered_mapæ›¿æ¢æˆåŸºæ•°æ ‘çš„ç»“æ„ï¼Œå¹¶ç”¨setå’Œgetå‡½æ•°ï¼Œæ›¿æ¢æ–¹æ‹¬å·å’Œfindçš„ä½œç”¨</p></blockquote><h3 id="æ›´æ”¹ä»£ç ">æ›´æ”¹ä»£ç </h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TCMalloc_PageMap1&lt;<span class="number">32</span> - PAGE_SHIFT&gt; _idSpanMap;  <span class="comment">//32-13=19ï¼Œæ€»å…±2^19ä¸ªé¡µ</span></span><br></pre></td></tr></table></figure><p>å»ºç«‹æ˜ å°„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_idSpanMap.<span class="built_in">set</span>(span-&gt;_pageId, span);</span><br></pre></td></tr></table></figure><p>è¯»å–Span</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Span* ret = (Span*)_idSpanMap.<span class="built_in">get</span>(id);</span><br></pre></td></tr></table></figure><h3 id="ä¼˜åŒ–åŸç†">ä¼˜åŒ–åŸç†</h3><blockquote><p>åŸºæ•°æ ‘çš„æ£€ç´¢å¯èƒ½ç•¥å¥½ä¸€ç‚¹ï¼Œä½†æ˜¯æœ€é‡è¦çš„æ˜¯åŸºæ•°æ ‘çš„ç»“æ„ä¸éœ€è¦åŠ é”ï¼Œmapå’Œunordered_mapï¼Œæ’å…¥æ•°æ®åº•å±‚çš„æ•°æ®ç»“æ„å¯èƒ½ä¼šå˜åŒ–ï¼Œæ¯”å¦‚çº¢é»‘æ ‘çš„é€‰æ‹©ï¼Œå“ˆå¸Œè¡¨çš„æ‰©å®¹ï¼Œæ‰€ä»¥åœ¨è¯»å–æ˜ å°„å…³ç³»æ—¶éœ€è¦åŠ é”ï¼Œä½†æ˜¯åŸºæ•°æ ‘ä¸€æ—¦å¼€å¥½ç©ºé—´å°±ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚<br>æˆ‘ä»¬ä¸ä¼šåŒæ—¶å¯¹ä¸€ä¸ªé¡µè¿›è¡Œè¯»å–æ˜ å°„å’Œå»ºç«‹æ˜ å°„çš„æ“ä½œï¼Œåªæœ‰åœ¨é‡Šæ”¾å¯¹è±¡çš„æ—¶å€™æ‰éœ€è¦è¯»å–ï¼Œå»ºç«‹æ˜ å°„éƒ½æ˜¯åœ¨page cacheä¸­è¿›è¡Œï¼Œå»ºç«‹æ˜ å°„çš„å¯¹åº”çš„spançš„usecountä¸º0ï¼Œè€Œè¯»å–å¯¹åº”çš„spançš„usecountä¸ä¸º0ï¼Œæ‰€ä»¥ä¸ä¼šå¯¹ä¸€ä¸ªé¡µåŒæ—¶è¿›è¡Œè¯»å–å’Œå»ºç«‹æ˜ å°„ã€‚</p></blockquote><h3 id="æ€§èƒ½å¯¹æ¯”">æ€§èƒ½å¯¹æ¯”</h3><blockquote><p>å†æ¬¡ä¸mallocè¿›è¡Œå¯¹æ¯”</p></blockquote><p>å›ºå®šå¤§å°çš„å¯¹è±¡çš„ç”³è¯·å’Œé‡Šæ”¾</p><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302171629323.png" alt="image.png"></p><p>ä¸å›ºå®šå¤§å°çš„å¯¹è±¡çš„ç”³è¯·å’Œé‡Šæ”¾</p><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302171627490.png" alt="image.png"></p><p>å¯ä»¥çœ‹åˆ°ä¸¤ç§åœºæ™¯ï¼Œéƒ½æ¯”mallocå¿«2~3å€å·¦å³</p>]]></content:encoded>
      
      
      <category domain="https://atong.run/categories/%E9%A1%B9%E7%9B%AE/">é¡¹ç›®</category>
      
      <category domain="https://atong.run/categories/%E9%A1%B9%E7%9B%AE/%E9%AB%98%E5%B9%B6%E5%8F%91%E5%86%85%E5%AD%98%E6%B1%A0/">é«˜å¹¶å‘å†…å­˜æ± </category>
      
      
      <category domain="https://atong.run/tags/%E9%A1%B9%E7%9B%AE/">é¡¹ç›®</category>
      
      
      <comments>https://atong.run/posts/1573212312/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>8ã€é«˜å¹¶å‘å†…å­˜æ± -ç»†èŠ‚å®Œå–„</title>
      <link>https://atong.run/posts/2734729201/</link>
      <guid>https://atong.run/posts/2734729201/</guid>
      <pubDate>Fri, 17 Feb 2023 06:09:42 GMT</pubDate>
      
        
        
      <description>&lt;blockquote&gt;
&lt;p&gt;æˆ‘ä»¬çš„å†…å­˜æ± å·²ç»å®Œæˆäº†ç”³è¯·å†…å­˜å’Œé‡Šæ”¾å†…å­˜çš„åŠŸèƒ½ä½†æ˜¯è¿˜æœ‰å‡ ä¸ªåœ°æ–¹æ²¡æœ‰å¤„ç†å®Œå–„ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;å¤§äº256KBçš„å†…å­˜ç”³è¯·&lt;/li&gt;
&lt;li&gt;å†…å­˜æ± çš„å†…éƒ¨è¦è„±ç¦»new&lt;/li&gt;
&lt;li&gt;é‡Šæ”¾å¯¹è±¡</description>
        
      
      
      
      <content:encoded><![CDATA[<blockquote><p>æˆ‘ä»¬çš„å†…å­˜æ± å·²ç»å®Œæˆäº†ç”³è¯·å†…å­˜å’Œé‡Šæ”¾å†…å­˜çš„åŠŸèƒ½ä½†æ˜¯è¿˜æœ‰å‡ ä¸ªåœ°æ–¹æ²¡æœ‰å¤„ç†å®Œå–„ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p></blockquote><ul><li>å¤§äº256KBçš„å†…å­˜ç”³è¯·</li><li>å†…å­˜æ± çš„å†…éƒ¨è¦è„±ç¦»new</li><li>é‡Šæ”¾å¯¹è±¡æ—¶çš„ç»†èŠ‚</li></ul><h1>å¤§äº256KBçš„å†…å­˜å¤„ç†</h1><h2 id="ç”³è¯·">ç”³è¯·</h2><blockquote><p>åœ¨ConcurrentAlloc.hæ–‡ä»¶ä¸­ï¼Œç”³è¯·å†…å­˜çš„æ—¶å€™è¦åˆ†ä¸¤ç§æƒ…å†µ</p></blockquote><ul><li>å°äº256kbèµ°thread cache</li><li>å¤§äº256kbèµ°page cache</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="title">ConcurrentAlloc</span><span class="params">(<span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (size &gt; MAX_BYTES)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// ç”³è¯·çš„å†…å­˜å¤§äºMAX_BYTES(256kb)</span></span><br><span class="line"><span class="comment">// èµ°Page Cacheå±‚ç”³è¯·</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…ˆè¿›è¡Œå¯¹é½</span></span><br><span class="line"><span class="type">size_t</span> alignSize = SizeClass::<span class="built_in">RoundUp</span>(size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç„¶åç®—éœ€è¦å‡ é¡µ</span></span><br><span class="line"><span class="type">size_t</span> kpage = alignSize &gt;&gt; PAGE_SHITF;</span><br><span class="line">PageCache::<span class="built_in">GetInstance</span>()-&gt;_pageMtx.<span class="built_in">lock</span>();</span><br><span class="line">Span* span = PageCache::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">NewSpan</span>(alignSize);</span><br><span class="line">PageCache::<span class="built_in">GetInstance</span>()-&gt;_pageMtx.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (<span class="type">void</span>*)(span-&gt;_pageId &lt;&lt; PAGE_SHITF);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (pTLSThreadCache == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">pTLSThreadCache = <span class="keyword">new</span> ThreadCache;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> pTLSThreadCache-&gt;<span class="built_in">Allocate</span>(size);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æˆ‘ä»¬SizeClasså¯¹é½çš„é€»è¾‘ï¼Œå¹¶æ²¡æœ‰å¤„ç†å¤§äº256KBçš„å†…å­˜ï¼Œæˆ‘ä»¬éœ€è¦å¢åŠ è¿™ä¸€éƒ¨åˆ†</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">size_t</span> <span class="title">RoundUp</span><span class="params">(<span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (size &lt;= <span class="number">128</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> _RoundUp(size, <span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (size &lt;= <span class="number">1024</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> _RoundUp(size, <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (size &lt;= <span class="number">8</span> * <span class="number">1024</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> _RoundUp(size, <span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (size &lt;= <span class="number">64</span> * <span class="number">1024</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> _RoundUp(size, <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (size &lt;= <span class="number">256</span> * <span class="number">1024</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> _RoundUp(size, <span class="number">8</span>*<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// å¤§äº256KB 1&lt;&lt;13 ä¹Ÿå°±æ˜¯8kb</span></span><br><span class="line"><span class="keyword">return</span> _RoundUp(size, <span class="number">1</span> &lt;&lt; PAGE_SHITF);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä½†æ˜¯è¿™ä¸ªå¤§äº256kbçš„è®©page cacheç”³è¯·ï¼Œè¿˜æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œå› ä¸ºpage cacheæœ€å¤šæä¾›128é¡µçš„å†…å­˜ï¼Œå¦‚æœç”³è¯·çš„å†…å­˜å¤§äº128é¡µï¼Œåˆ™è¿˜æ˜¯éœ€è¦è¿›è¡Œå¤„ç†ï¼Œè¿™éƒ¨åˆ†ï¼Œæˆ‘ä»¬åœ¨page cacheä¸­è¿›è¡Œå¤„ç†ã€‚</p></blockquote><pre><code>PageCache::NewSpanå‡½æ•°ä¸­ï¼Œå¢åŠ ç”³è¯·å¤§äº128é¡µçš„spançš„é€»è¾‘</code></pre><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœk &gt; 128é¡µ èµ°ç³»ç»Ÿè°ƒç”¨</span></span><br><span class="line"><span class="keyword">if</span> (k &gt; NPAGES - <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">void</span>* ptr = <span class="built_in">SystemAlloc</span>(k);</span><br><span class="line">Span* span = <span class="keyword">new</span> Span;</span><br><span class="line">span-&gt;_pageId = (PAGE_ID)ptr &gt;&gt; PAGE_SHITF;</span><br><span class="line">span-&gt;_n = k;</span><br><span class="line"></span><br><span class="line">_idSpanMap[span-&gt;_pageId] = span;</span><br><span class="line"><span class="keyword">return</span> span;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é‡Šæ”¾">é‡Šæ”¾</h2><blockquote><p>å¤§äº256kbçš„å†…å­˜ï¼Œé‡Šæ”¾æ—¶ï¼ŒåŒæ ·ä¸èƒ½èµ°thread cacheå±‚å›æ”¶ï¼Œè¦æœ‰å•ç‹¬çš„å›æ”¶é€»è¾‘ï¼Œæˆ‘ä»¬è¿˜æ˜¯é€šè¿‡pagecacheå±‚å›æ”¶</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">ConcurrentFree</span><span class="params">(<span class="type">void</span>* ptr, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (size &gt; MAX_BYTES)</span><br><span class="line">&#123;</span><br><span class="line">Span* span = PageCache::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">MapObjectToSpan</span>(ptr);</span><br><span class="line"></span><br><span class="line">PageCache::<span class="built_in">GetInstance</span>()-&gt;_pageMtx.<span class="built_in">lock</span>();</span><br><span class="line">PageCache::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">ReleaseSpanToPageCache</span>(span);</span><br><span class="line">PageCache::<span class="built_in">GetInstance</span>()-&gt;_pageMtx.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">assert</span>(pTLSThreadCache);</span><br><span class="line">pTLSThreadCache-&gt;<span class="built_in">Deallocate</span>(ptr, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>åŒæ ·ï¼Œåœ¨pagecacheå±‚ä¸­è¿˜è¦åˆ†ä¸ºï¼Œè¿™ä¸ªå†…å­˜æ˜¯å¤§äº128é¡µè¿˜æ˜¯å°äº128é¡µï¼Œå°äº128ç›´æ¥èµ°Page cacheå±‚çš„å›æ”¶é€»è¾‘ï¼Œå¤§äº128é¡µçš„é€šè¿‡ç³»ç»Ÿè°ƒç”¨å›æ”¶</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é‡Šæ”¾ç©ºé—²spanå›åˆ°PageCacheï¼Œå¹¶åˆå¹¶ç›¸é‚»çš„span</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PageCache::ReleaseSpanToPageCache</span><span class="params">(Span* span)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (span-&gt;_n &gt; NPAGES - <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">void</span>* ptr = (<span class="type">void</span>*)(span-&gt;_pageId &lt;&lt; PAGE_SHITF);</span><br><span class="line"><span class="built_in">SystemFree</span>(ptr);</span><br><span class="line"><span class="keyword">delete</span> span;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åˆå¹¶ç›¸é‚»çš„spanï¼Œå‘å‰åˆå¹¶ï¼Œæœ‰é—®é¢˜ï¼šå‰é¢çš„spanå¦‚æœè¢«ç”¨å°±ä¸èƒ½è¿›è¡Œåˆå¹¶</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">PAGE_ID prevId = span-&gt;_pageId - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> ret = _idSpanMap.<span class="built_in">find</span>(prevId);</span><br><span class="line"><span class="comment">//å‰è¾¹çš„é¡µå·æ²¡æœ‰äº†å°±ä¸å’Œå¹¶äº†</span></span><br><span class="line"><span class="keyword">if</span> (ret == _idSpanMap.<span class="built_in">end</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‰è¾¹ç›¸é‚»é¡µåœ¨ä½¿ç”¨ï¼Œä¸åˆå¹¶</span></span><br><span class="line">Span* prevSpan = ret-&gt;second;</span><br><span class="line"><span class="keyword">if</span> (prevSpan-&gt;_isUse == <span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¶…è¿‡128é¡µçš„spanä¹Ÿä¸åˆå¹¶</span></span><br><span class="line"><span class="keyword">if</span> (prevSpan-&gt;_n + span-&gt;_n &gt; NPAGES - <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿›å…¥åˆå¹¶çš„é€»è¾‘</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//span-&gt;_pageId -= prevSpan-&gt;_n;</span></span><br><span class="line">span-&gt;_pageId = prevSpan-&gt;_pageId;</span><br><span class="line">span-&gt;_n += prevSpan-&gt;_n;</span><br><span class="line"></span><br><span class="line">_spanLists[prevSpan-&gt;_n].<span class="built_in">Erase</span>(prevSpan);</span><br><span class="line"><span class="keyword">delete</span> prevSpan;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">PAGE_ID nextID = span-&gt;_pageId + span-&gt;_n;</span><br><span class="line"><span class="keyword">auto</span> ret = _idSpanMap.<span class="built_in">find</span>(nextID);</span><br><span class="line"><span class="keyword">if</span> (ret == _idSpanMap.<span class="built_in">end</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Span* nextSpan = ret-&gt;second;</span><br><span class="line"><span class="keyword">if</span> (nextSpan-&gt;_isUse == <span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¶…è¿‡128é¡µçš„spanä¹Ÿä¸åˆå¹¶</span></span><br><span class="line"><span class="keyword">if</span> (nextSpan-&gt;_n + span-&gt;_n &gt; NPAGES - <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">span-&gt;_n += nextSpan-&gt;_n;</span><br><span class="line"></span><br><span class="line">_spanLists[nextSpan-&gt;_n].<span class="built_in">Erase</span>(nextSpan);</span><br><span class="line"><span class="keyword">delete</span> nextSpan;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_spanLists[span-&gt;_n].<span class="built_in">PushFront</span>(span);</span><br><span class="line">span-&gt;_isUse = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">_idSpanMap[span-&gt;_pageId] = span;</span><br><span class="line">_idSpanMap[span-&gt;_pageId + span-&gt;_n - <span class="number">1</span>] = span;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œå°è£…çš„äº†Windowsç³»ç»Ÿçš„VirtualFreeå‡½æ•°ï¼Œè¿›è¡Œå¤§äº128é¡µçš„å†…å­˜é‡Šæ”¾</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨ç³»ç»Ÿæ¥å£é‡Šæ”¾å†…å­˜</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">static</span> <span class="type">void</span> <span class="title">SystemFree</span><span class="params">(<span class="type">void</span>* ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN32</span></span><br><span class="line"><span class="built_in">VirtualFree</span>(ptr, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="comment">// sbrk unmmapç­‰</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>ä½¿ç”¨å®šé•¿å†…å­˜æ± é…åˆè„±ç¦»new</h1><blockquote><p>æˆ‘ä»¬çš„å†…å­˜æ± æœŸæœ›çš„æ˜¯åœ¨å†…éƒ¨ä¸ä½¿ç”¨mallocå‡½æ•°ç”³è¯·å†…å­˜ï¼Œèµ°è‡ªå·±çš„ä¸€å¥—ç”³è¯·é‡Šæ”¾ä½“ç³»ï¼Œä½†æ˜¯ç›®å‰æˆ‘ä»¬çš„ä»£ç ä¸­ï¼Œè¿˜æ˜¯æœ‰ä¸å°‘åœ°æ–¹ï¼ˆnew spançš„å¯¹è±¡ï¼‰ä½¿ç”¨äº†newï¼Œä¸ºäº†å®Œå…¨è„±ç¦»newï¼Œæˆ‘ä»¬å¯ä»¥é…åˆä¹‹å‰çš„å®šé•¿å†…å­˜æ± ã€‚</p></blockquote><h2 id="ç”³è¯·-2">ç”³è¯·</h2><p>å› ä¸ºspanå¯¹è±¡éƒ½æ˜¯åœ¨page cacheå±‚newå‡ºæ¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨page cacheå±‚å¢åŠ ä¸€ä¸ªå®šé•¿å†…å­˜æ± å¯¹è±¡</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ObjectPool&lt;Span&gt; _spanPool;</span><br></pre></td></tr></table></figure><blockquote><p>ç„¶åæˆ‘ä»¬åœ¨new Spançš„åœºæ™¯ä¸‹ï¼Œæ›¿æ¢æˆå®šé•¿å†…å­˜æ± çš„ç”³è¯·</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Span* span = <span class="keyword">new</span> Span;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸Šè¾¹æ›¿æ¢æˆä¸‹è¾¹</span></span><br><span class="line"></span><br><span class="line">Span* span = _spanPool.<span class="built_in">New</span>();</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨çº¿ç¨‹ç”³è¯·åˆ›å»ºthread cacheæ—¶ï¼Œä¹Ÿæ˜¯é€šè¿‡newè¿›è¡Œç”³è¯·çš„ï¼ŒåŒæ ·è¿›è¡Œæ›¿æ¢</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pTLSThreadCache == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/*pTLSThreadCache = new ThreadCache;*/</span></span><br><span class="line"><span class="type">static</span> ObjectPool&lt;ThreadCache&gt; tcPool;</span><br><span class="line">pTLSThreadCache = tcPool.<span class="built_in">New</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é‡Šæ”¾-2">é‡Šæ”¾</h2><blockquote><p>å¯¹åº”çš„deleteä¹Ÿè¦æ›¿æ¢æˆå®šé•¿å†…å­˜æ± çš„Delete</p></blockquote><h1>é‡Šæ”¾å†…å­˜ä¼˜åŒ–ä¸ºä¸ä¼ å¯¹è±¡å¤§å°</h1><blockquote><p>æˆ‘ä»¬ç”¨freeæ—¶ï¼Œåªéœ€è¦ä¼ å…¥ä¸€ä¸ªæŒ‡é’ˆå³å¯ï¼Œä½†æ˜¯æˆ‘ä»¬ç›®å‰çš„å†…å­˜æ± é‡Šæ”¾å†…å­˜ï¼Œä¸ä»…è¦ä¼ å…¥æŒ‡é’ˆï¼Œè¿˜éœ€è¦ä¼ å…¥å¾…é‡Šæ”¾å†…å­˜çš„å¤§å°ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä¼˜åŒ–ä¸ºä¸ä¼ å…¥å¯¹è±¡çš„å¤§å°</p></blockquote><p>æˆ‘ä»¬å¯ä»¥åœ¨spanå¯¹è±¡ä¸­å¢åŠ æˆå‘˜ï¼šObjSize ç”¨æ¥è®°å½•spanä¸­æ¯ä¸ªå¯¹è±¡çš„å¤§å°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> _ObjSize = <span class="number">0</span>; <span class="comment">// åˆ‡å¥½çš„å°å¯¹è±¡çš„å¤§å°</span></span><br></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬çš„é‡Šæ”¾å†…å­˜çš„å‡½æ•°å°±å¯ä»¥æ”¹ä¸ºä¸‹è¾¹çš„å†™æ³•</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">ConcurrentFree</span><span class="params">(<span class="type">void</span>* ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Span* span = PageCache::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">MapObjectToSpan</span>(ptr);</span><br><span class="line"><span class="type">size_t</span> size = span-&gt;_ObjSize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (size &gt; MAX_BYTES)</span><br><span class="line">&#123;</span><br><span class="line">PageCache::<span class="built_in">GetInstance</span>()-&gt;_pageMtx.<span class="built_in">lock</span>();</span><br><span class="line">PageCache::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">ReleaseSpanToPageCache</span>(span);</span><br><span class="line">PageCache::<span class="built_in">GetInstance</span>()-&gt;_pageMtx.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">assert</span>(pTLSThreadCache);</span><br><span class="line">pTLSThreadCache-&gt;<span class="built_in">Deallocate</span>(ptr, size);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ç°åœ¨çš„é—®é¢˜å°±å˜æˆäº†ï¼ŒObjSizeçš„è®°å½•é—®é¢˜äº†ï¼Œæˆ‘ä»¬æ•´ä¸ªå†…å­˜æ± ä¸­çš„spanå¯¹è±¡éƒ½æ˜¯ä»Page cacheå±‚å‡ºæ¥çš„ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨NewSpançš„æ—¶å€™ï¼Œè¦å°†åˆ‡åˆ†çš„å¯¹è±¡çš„å¤§å°è®°å½•ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”³è¯·å°äº256kbçš„å¯¹è±¡æ—¶ï¼Œéƒ½èµ°çš„thread cache-&gt;central cache-&gt;page cacheï¼Œå¦ä¸€ç§æƒ…å†µæ˜¯å¤§äº256kbç›´æ¥æ‰¾page cacheï¼Œè¿™ä¸¤ä¸ªåœ°æ–¹éƒ½éœ€è¦è®°å½•ObjSize</p></blockquote><p>1ã€åœ¨Centralå±‚è°ƒç”¨NewSpanåï¼Œä½¿å¾—span-&gt;ObjSize=size</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æˆ‘ä»¬è¦è®¡ç®—å‘page cacheå±‚è¦å¤šå°‘é¡µçš„span</span></span><br><span class="line">Span* span = PageCache::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">NewSpan</span>(SizeClass::<span class="built_in">NumMovePage</span>(size));</span><br><span class="line">span-&gt;_ObjSize = size;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2ã€CurrentAllocä¸­ï¼Œç”³è¯·å¤§äº256KBçš„å¯¹è±¡</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Span* span = PageCache::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">NewSpan</span>(alignSize);</span><br><span class="line">span-&gt;_ObjSize = alignSize;</span><br></pre></td></tr></table></figure><h1>STLçº¿ç¨‹å®‰å…¨é—®é¢˜</h1><blockquote><p>æˆ‘ä»¬é€šè¿‡unordered_mapï¼Œå»ºç«‹äº†PAGE_IDå’ŒSpan* çš„è”ç³»ï¼ŒPageCacheå±‚ï¼Œæœ‰è¯»å†™æ“ä½œï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨PageCacheçš„NewSpanå‡½æ•°æ—¶ï¼Œéƒ½ä¼šåŠ é”ï¼Œä½†æ˜¯CentralCacheå±‚å’ŒConcurrentFreeå‡½æ•°ä¸­ä¼šæœ‰è¯»æ“ä½œï¼Œè€Œä¸”å¹¶æœªåŠ é”ï¼Œè¿™æ ·ï¼Œå¯èƒ½æœ‰çº¿ç¨‹æ­£åœ¨æ”¹ï¼Œå°±æœ‰çº¿ç¨‹è¯»å–ï¼Œä¼šæœ‰çº¿ç¨‹å®‰å…¨çš„é—®é¢˜</p></blockquote><p>æˆ‘ä»¬åœ¨MapObjectToSpanå‡½æ•°ä¸­åŠ é”</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–å¯¹è±¡åˆ°spançš„æ˜ å°„</span></span><br><span class="line"><span class="function">Span* <span class="title">PageCache::MapObjectToSpan</span><span class="params">(<span class="type">void</span>* obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PAGE_ID id = ((PAGE_ID)obj &gt;&gt; PAGE_SHITF);</span><br><span class="line"><span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(_pageMtx)</span></span>;</span><br><span class="line"><span class="keyword">if</span> (_idSpanMap.<span class="built_in">find</span>(id) != _idSpanMap.<span class="built_in">end</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> _idSpanMap[id];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">assert</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content:encoded>
      
      
      <category domain="https://atong.run/categories/%E9%A1%B9%E7%9B%AE/">é¡¹ç›®</category>
      
      <category domain="https://atong.run/categories/%E9%A1%B9%E7%9B%AE/%E9%AB%98%E5%B9%B6%E5%8F%91%E5%86%85%E5%AD%98%E6%B1%A0/">é«˜å¹¶å‘å†…å­˜æ± </category>
      
      
      <category domain="https://atong.run/tags/%E9%A1%B9%E7%9B%AE/">é¡¹ç›®</category>
      
      
      <comments>https://atong.run/posts/2734729201/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>7ã€é«˜å¹¶å‘å†…å­˜æ± -é‡Šæ”¾å†…å­˜</title>
      <link>https://atong.run/posts/3511365265/</link>
      <guid>https://atong.run/posts/3511365265/</guid>
      <pubDate>Tue, 14 Feb 2023 05:41:56 GMT</pubDate>
      
        
        
      <description>&lt;blockquote&gt;
&lt;p&gt;å‰é¢å‡ ä¸ªç« èŠ‚ï¼Œè¯¦ç»†è¯´æ˜äº†thread cacheã€central cacheã€page cacheå±‚çš„ç»“æ„ä»¥åŠç”³è¯·å†…å­˜çš„é€»è¾‘ã€‚æœ¬èŠ‚å°±æ˜¯è®²è¿°å›æ”¶å†…å­˜çš„è¿‡ç¨‹ï¼Œå¤§è‡´åˆ†ä¸ºä¸‹è¾¹å‡ æ­¥ï¼š&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;thread cac</description>
        
      
      
      
      <content:encoded><![CDATA[<blockquote><p>å‰é¢å‡ ä¸ªç« èŠ‚ï¼Œè¯¦ç»†è¯´æ˜äº†thread cacheã€central cacheã€page cacheå±‚çš„ç»“æ„ä»¥åŠç”³è¯·å†…å­˜çš„é€»è¾‘ã€‚æœ¬èŠ‚å°±æ˜¯è®²è¿°å›æ”¶å†…å­˜çš„è¿‡ç¨‹ï¼Œå¤§è‡´åˆ†ä¸ºä¸‹è¾¹å‡ æ­¥ï¼š</p></blockquote><ul><li>thread cacheæŒ‚çš„è‡ªç”±é“¾è¡¨è¿‡é•¿ï¼Œå°†å†…å­˜é‡Šæ”¾å›central cache</li><li>central cacheç®¡ç†çš„spançš„å†…å­˜å—å…¨éƒ¨å›æ¥åï¼Œå°†spané‡Šæ”¾å›page cache</li><li>page cacheåˆå¹¶å‰åç›¸é‚»çš„ç©ºé—²é¡µ</li></ul><h1>ThreadCacheå±‚å›æ”¶å†…å­˜</h1><blockquote><p>å½“çº¿ç¨‹é‡Šæ”¾å†…å­˜å—æ—¶ï¼Œç›´æ¥å°†å†…å­˜å—æŒ‚åˆ°ç›¸åº”çš„ThreadCacheçš„è‡ªç”±é“¾è¡¨ï¼Œå½“è‡ªç”±é“¾è¡¨çš„é•¿åº¦è¾¾åˆ°thread cacheå±‚å‘central cacheå±‚ç”³è¯·å†…å­˜çš„ä¸€ä¸ªæ‰¹é‡çš„å¤§å°æˆ‘ä»¬å°±è¿›è¡Œé‡Šæ”¾ï¼Œä¹Ÿå°±æ˜¯åˆ°MaxSizeï¼ˆæ…¢å¢é•¿è®°å½•ï¼‰</p></blockquote><pre><code>è¿™é‡Œæ³¨æ„ï¼Œæˆ‘ä»¬å¢åŠ äº†FreeListæˆå‘˜_sizeï¼Œå¹¶æä¾›äº†è¿”å›å®ƒå¤§å°çš„å‡½æ•°Size</code></pre><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é‡Šæ”¾å†…å­˜</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ThreadCache::Deallocate</span><span class="params">(<span class="type">void</span>* obj, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">assert</span>(obj);</span><br><span class="line"><span class="built_in">assert</span>(size &lt;= MAX_BYTES);</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> index = SizeClass::<span class="built_in">Index</span>(size);</span><br><span class="line">_freeLists[index].<span class="built_in">Push</span>(obj);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœè‡ªç”±é“¾è¡¨çš„é•¿åº¦å¤§äºç”³è¯·ä¸€ä¸ªæ‰¹é‡çš„é•¿åº¦å°±è¿˜ç»™central cache </span></span><br><span class="line"><span class="keyword">if</span> (_freeLists[index].<span class="built_in">Size</span>() &gt;= _freeLists[index].<span class="built_in">MaxSize</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">ListTooLong</span>(_freeLists[index], size);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>é«˜å¹¶å‘å†…å­˜æ± ï¼ŒConcurrentDeallocé‡Šæ”¾å†…å­˜ï¼Œå†…éƒ¨è°ƒç”¨thread cacheå±‚çš„Deallocateå‡½æ•°ï¼ŒDeallocateå‡½æ•°å†…éƒ¨è°ƒç”¨ListTooLongå»å¤„ç†é•¿é“¾è¡¨å½’è¿˜ç»™central cacheå±‚</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ThreadCache::ListTooLong</span><span class="params">(FreeList&amp; list, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">void</span>* start = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="type">void</span>* end = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…ˆå°†MaxSizeé•¿åº¦çš„å†…å­˜ï¼Œä»thread cacheå±‚é‡Šæ”¾å‡ºæ¥</span></span><br><span class="line">list.<span class="built_in">PopRange</span>(start, end, list.<span class="built_in">MaxSize</span>());</span><br><span class="line"></span><br><span class="line">CentralCache::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">ReleaseListToSpans</span>(start, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦å…ˆè°ƒç”¨PopRangeé‡Šæ”¾æŒ‚åœ¨è‡ªç”±é“¾è¡¨MaxSizeé•¿åº¦ï¼ˆè¿™ä¸ªä¹‹å‰æœªå®ç°ï¼‰ï¼Œç„¶åè°ƒç”¨CentralCacheå±‚ReleaseListToSpansï¼Œæ¥å›æ”¶è¿™æ®µå†…å­˜ï¼Œæ¥ä¸‹æ¥çš„å·¥ä½œäº¤ç»™CentralCacheå±‚è¿›è¡Œå¤„ç†</p><h1>CentralCacheå±‚å›æ”¶å†…å­˜</h1><blockquote><p>thread cacheå±‚å½’è¿˜å›äº†ä¸€æ®µå†…å­˜ï¼Œè¿™é‡Œå°±ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ç›´åˆ°Central Cacheå±‚çš„å“ˆå¸Œæ¡¶ç»“æ„å’Œæ˜ å°„è§„åˆ™ä¸thread cacheå±‚ç›¸åŒï¼Œä½†æ˜¯central cacheå±‚æŒ‚çš„æ˜¯ä¸€ä¸ªä¸ªçš„spanå¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸€æ®µå†…å­˜ï¼Œåº”è¯¥å½’è¿˜ç»™æŸä¸ªæ¡¶çš„å“ªä¸ªspanå¯¹è±¡å‘¢ï¼Ÿ</p></blockquote><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302131526327.png" alt="image.png"></p><p>åœ¨page cacheä¸­ï¼Œç”³è¯·å†…å­˜éƒ½æ˜¯æŒ‰é¡µç”³è¯·ï¼Œé‚£ä¹ˆè¿™ä¸€é¡µå†…å­˜åˆ°ä¸‹ä¸€é¡µçš„ä»»ä½•ä¸€ä¸ªåœ°å€ï¼Œå³ç§»PAGE_SHIFTä½éƒ½æ˜¯è¿™é¡µå†…å­˜çš„é¡µå·ã€‚æ¯”å¦‚ä¸‹å›¾çš„ä¾‹å­ï¼Œæˆ‘ä»¬å°±ä»¥é€šè¿‡åœ°å€æ¥ç®—è¿™å—å†…å­˜åº”è¯¥åœ¨é‚£ä¸€é¡µï¼Œç„¶åå»æ‰¾åˆ°å¯¹åº”çš„spanï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬æ²¡åŠæ³•æ‰¾åˆ°</p><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302132255489.png" alt="image.png"></p><blockquote><p>ä¸ºäº†èƒ½é€šè¿‡é¡µå·ï¼Œæ‰¾åˆ°å¯¹åº”spançš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥å»ºç«‹ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œæ˜ å°„å…³ç³»ä¸ºpage_idå·å’Œå¯¹åº”spançš„æŒ‡é’ˆï¼Œæˆ‘ä»¬åœ¨PageCacheç±»ä¸­å¢åŠ ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼ŒPageCacheå±‚ä¹Ÿä¼šç”¨åˆ°</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::unordered_map&lt;PAGE_ID, Span*&gt; _idSpanMap;</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™å°±éœ€è¦è®°å½•é¡µå·å’Œspan* çš„å¯¹åº”å…³ç³»ï¼ŒPageCacheçš„NewSpanå‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªspanï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ªå‡½æ•°é‡Œå¢åŠ ç›¸å…³ä»£ç </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­˜å‚¨nSpançš„é¦–å°¾é¡µè·ŸnSpanå»ºç«‹æ˜ å°„ï¼Œæ–¹ä¾¿page cacheå›æ”¶å†…å­˜</span></span><br><span class="line"></span><br><span class="line">_idSpanMap[nSpan-&gt;_pageId] = nSpan;</span><br><span class="line">_idSpanMap[nSpan-&gt;_pageId + nSpan-&gt;_n - <span class="number">1</span>] = nSpan;  <span class="comment">//åŸç†å¦‚ä¸‹å›¾</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›çš„kSpanï¼Œä¹Ÿè¦å»ºç«‹idå’Œspançš„æ˜ å°„ï¼Œæ–¹ä¾¿central cacheå›æ”¶å°å—å†…å­˜æ—¶ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„span</span></span><br><span class="line"><span class="comment">// ç»™centralå±‚è¿”å›çš„spanï¼Œä¼šè¢«åˆ‡åˆ†æˆå°å—å†…å­˜ï¼Œå½’è¿˜çš„æ—¶å€™åœ°å€æ¢æˆé¡µå·å°±å¯èƒ½æ˜¯å…¶ä¸­çš„æŸä¸€é¡µ</span></span><br><span class="line"><span class="keyword">for</span> (PAGE_ID i = <span class="number">0</span>; i &lt; kSpan-&gt;_n; ++i)</span><br><span class="line">&#123;</span><br><span class="line">_idSpanMap[kSpan-&gt;_pageId + i] = kSpan;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302132221620.png" alt="image.png"></p><blockquote><p>è®°å½•å®Œæ˜ å°„å…³ç³»ä¹‹åï¼Œå¯ä»¥ç»§ç»­åœ¨å°è£…ä¸€ä¸ªå‡½æ•°ï¼ŒåŠŸèƒ½å°±æ˜¯ç»™æˆ‘ä¸€ä¸ªåœ°å€ï¼Œæˆ‘å°±è¿”å›å®ƒåº”è¯¥æ‰€åœ¨çš„spançš„åœ°å€</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–å¯¹è±¡åˆ°spançš„æ˜ å°„</span></span><br><span class="line"><span class="function">Span* <span class="title">PageCache::MapObjectToSpan</span><span class="params">(<span class="type">void</span>* obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PAGE_ID id = ((PAGE_ID)obj &gt;&gt; PAGE_SHITF);</span><br><span class="line"><span class="keyword">if</span> (_idSpanMap.<span class="built_in">find</span>(id) != _idSpanMap.<span class="built_in">end</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> _idSpanMap[id];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">assert</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸Šè¾¹å‰ç½®å·¥ä½œåšå®Œä¹‹åï¼Œå¯ä»¥å†™ReleaseListToSpanså‡½æ•°äº†ï¼Œå¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ç‚¹ï¼š</p></blockquote><ol><li>é€šè¿‡èµ·å§‹åœ°å€ï¼Œä¸æ–­å‘åèµ°ï¼Œæ‰¾åˆ°å¯¹åº”çš„spanï¼Œç„¶åå¤´æ’è¿›spançš„è‡ªç”±é“¾è¡¨</li><li>è®©å¯¹åº”çš„spançš„_useCountï¼Œå½“å‡åˆ°0è¯´æ˜ï¼Œè¿™ä¸ªspançš„æ‰€æœ‰å†…å­˜å—éƒ½å›æ¥äº†ï¼Œè¯¥spanå¯ä»¥è¢«å›æ”¶</li><li>ä»spanlistä¸­å°†å¯¹åº”çš„spanåˆ é™¤æ‰ï¼Œç„¶åè®©pagecacheå›æ”¶</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CentralCache::ReleaseListToSpans</span><span class="params">(<span class="type">void</span>* start, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">size_t</span> index = SizeClass::<span class="built_in">Index</span>(size);</span><br><span class="line"></span><br><span class="line">_spanLists[index]._mtx.<span class="built_in">lock</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// é—®é¢˜ï¼šæ¢å›æ¥çš„å†…å­˜æŒ‚åˆ°å“ªä¸ªspanä¸Šï¼Ÿ</span></span><br><span class="line"><span class="comment">// é€šè¿‡åœ°å€ start&gt;&gt;PAGE_SHIFTï¼Œå°±æ˜¯spançš„é¡µå·ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥å»ºç«‹é¡µå·å’ŒspanæŒ‡é’ˆçš„æ˜ å°„</span></span><br><span class="line"><span class="comment">// è¿™é‡Œå¯ä»¥é€šè¿‡å“ˆå¸Œè¡¨åš- unordered_map&lt;PAGE_ID, Span*&gt; </span></span><br><span class="line"><span class="keyword">while</span> (start)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">void</span>* next = <span class="built_in">NextObj</span>(start);</span><br><span class="line">Span* span = PageCache::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">MapObjectToSpan</span>(start);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤´æ’è¿›spançš„ç®¡ç†çš„é“¾è¡¨</span></span><br><span class="line"><span class="built_in">NextObj</span>(start) = span-&gt;_freeList;</span><br><span class="line">span-&gt;_freeList = start;</span><br><span class="line"></span><br><span class="line">span-&gt;_useCount--;</span><br><span class="line"></span><br><span class="line"><span class="comment">// spanåˆ‡åˆ†å›å»çš„å°å—å†…å­˜éƒ½å›æ¥äº†</span></span><br><span class="line"><span class="comment">// å°†è¿™ä¸ªspan å›æ”¶ç»™page cache</span></span><br><span class="line"><span class="keyword">if</span> (span-&gt;_useCount == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">_spanLists[index].<span class="built_in">Erase</span>(span);</span><br><span class="line">span-&gt;_next = <span class="literal">nullptr</span>;</span><br><span class="line">span-&gt;_next = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="comment">// spanç®¡ç†å†…å­˜ï¼Œé€šè¿‡é¡µå·å’Œé¡µæ•°å°±å¯ä»¥</span></span><br><span class="line">span-&gt;_freeList = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">_spanLists[index]._mtx.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">PageCache::<span class="built_in">GetInstance</span>()-&gt;_pageMtx.<span class="built_in">lock</span>();</span><br><span class="line">PageCache::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">ReleaseSpanToPageCache</span>(span);</span><br><span class="line"></span><br><span class="line">PageCache::<span class="built_in">GetInstance</span>()-&gt;_pageMtx.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">_spanLists[index]._mtx.<span class="built_in">lock</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">start = next;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è§£é”</span></span><br><span class="line">_spanLists[index]._mtx.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1>PageCacheå±‚å›æ”¶å†…å­˜</h1><blockquote><p>page cacheå°±å›æ”¶spanï¼Œå¹¶ä¸”åˆå¹¶ç›¸é‚»çš„spanï¼Œå¯ä»¥å‘å‰åˆå¹¶ä¹Ÿå¯ä»¥å‘ååˆå¹¶ï¼Œä½†æ˜¯åˆå¹¶æœ‰ä¸ªé—®é¢˜ï¼šåªèƒ½åˆå¹¶æ²¡æœ‰ç”¨çš„spanï¼Œå¦‚æœæœ‰çš„spanæ­£åœ¨è¢«ç”¨å°±ä¸èƒ½åˆå¹¶ï¼Œå¤§è‡´æ­¥éª¤å¦‚ä¸‹ï¼š</p></blockquote><p>é¦–å…ˆåˆ¤æ–­spanæ˜¯å¦è¢«ä½¿ç”¨ï¼Ÿæˆ‘ä»¬åœ¨Spanç±»ä¸­å¢åŠ æˆå‘˜ï¼Œåˆ¤æ–­è¯¥spanå¯¹è±¡æœ‰æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰è¢«ä½¿ç”¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> _isUse = <span class="literal">false</span>; <span class="comment">//æ˜¯å¦è¢«ä½¿ç”¨</span></span><br></pre></td></tr></table></figure><p>åœ¨Central Cacheå±‚ä¸­æˆ‘ä»¬å‘PageCacheç”³è¯·æ–°çš„spanï¼Œè¿™æ—¶éœ€è¦å°†isUseæ”¹æˆtrueï¼Œæ ‡è¯†è¿™ä¸ªspanè¢«ç”¨äº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æˆ‘ä»¬è¦è®¡ç®—å‘page cacheå±‚è¦å¤šå°‘é¡µçš„span</span></span><br><span class="line">Span* span = PageCache::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">NewSpan</span>(SizeClass::<span class="built_in">NumMovePage</span>(size));</span><br><span class="line">span-&gt;_isUse = <span class="literal">true</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯å‘å‰å‘ååˆå¹¶spanï¼Œéœ€è¦æ³¨æ„ï¼š</p><ul><li>å½“åˆå¹¶åˆ°å¤´äº†å°±ä¸å†åˆå¹¶äº†</li><li>å‰åçš„é¡µæœ‰è¢«ä½¿ç”¨çš„ä¹Ÿä¸åˆå¹¶</li><li>åˆå¹¶çš„é•¿åº¦å·²ç»è¶…è¿‡128ä¹Ÿä¸å†è¿›è¡Œåˆå¹¶</li></ul><blockquote><p>å‘å‰åˆå¹¶é€»è¾‘</p></blockquote><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302140054029.png" alt="image.png"></p><blockquote><p>å‘ååˆå¹¶é€»è¾‘</p></blockquote><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302140100674.png" alt="image.png"></p><blockquote><p>æ•´ä½“ä»£ç </p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é‡Šæ”¾ç©ºé—²spanå›åˆ°PageCacheï¼Œå¹¶åˆå¹¶ç›¸é‚»çš„span</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PageCache::ReleaseSpanToPageCache</span><span class="params">(Span* span)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// åˆå¹¶ç›¸é‚»çš„spanï¼Œå‘å‰åˆå¹¶ï¼Œæœ‰é—®é¢˜ï¼šå‰é¢çš„spanå¦‚æœè¢«ç”¨å°±ä¸èƒ½è¿›è¡Œåˆå¹¶</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">PAGE_ID prevId = span-&gt;_pageId - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> ret = _idSpanMap.<span class="built_in">find</span>(prevId);</span><br><span class="line"><span class="comment">//å‰è¾¹çš„é¡µå·æ²¡æœ‰äº†å°±ä¸å’Œå¹¶äº†</span></span><br><span class="line"><span class="keyword">if</span> (ret == _idSpanMap.<span class="built_in">end</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‰è¾¹ç›¸é‚»é¡µåœ¨ä½¿ç”¨ï¼Œä¸åˆå¹¶</span></span><br><span class="line">Span* prevSpan = ret-&gt;second;</span><br><span class="line"><span class="keyword">if</span> (prevSpan-&gt;_isUse == <span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¶…è¿‡128é¡µçš„spanä¹Ÿä¸åˆå¹¶</span></span><br><span class="line"><span class="keyword">if</span> (prevSpan-&gt;_n + span-&gt;_n &gt; NPAGES - <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿›å…¥åˆå¹¶çš„é€»è¾‘</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//span-&gt;_pageId -= prevSpan-&gt;_n;</span></span><br><span class="line">span-&gt;_pageId = prevSpan-&gt;_pageId;</span><br><span class="line">span-&gt;_n += prevSpan-&gt;_n;</span><br><span class="line"></span><br><span class="line">_spanLists[prevSpan-&gt;_n].<span class="built_in">Erase</span>(prevSpan);</span><br><span class="line"><span class="keyword">delete</span> prevSpan;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">PAGE_ID nextID = span-&gt;_pageId + span-&gt;_n;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> ret = _idSpanMap.<span class="built_in">find</span>(nextID);</span><br><span class="line"><span class="keyword">if</span> (ret == _idSpanMap.<span class="built_in">end</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Span* nextSpan = ret-&gt;second;</span><br><span class="line"><span class="keyword">if</span> (nextSpan-&gt;_isUse == <span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¶…è¿‡128é¡µçš„spanä¹Ÿä¸åˆå¹¶</span></span><br><span class="line"><span class="keyword">if</span> (nextSpan-&gt;_n + span-&gt;_n &gt; NPAGES - <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">span-&gt;_n += nextSpan-&gt;_n;</span><br><span class="line"></span><br><span class="line">_spanLists[nextSpan-&gt;_n].<span class="built_in">Erase</span>(nextSpan);</span><br><span class="line"><span class="keyword">delete</span> nextSpan;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_spanLists[span-&gt;_n].<span class="built_in">PushFront</span>(span);</span><br><span class="line">span-&gt;_isUse = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">_idSpanMap[span-&gt;_pageId] = span;</span><br><span class="line">_idSpanMap[span-&gt;_pageId + span-&gt;_n - <span class="number">1</span>] = span;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content:encoded>
      
      
      <category domain="https://atong.run/categories/%E9%A1%B9%E7%9B%AE/">é¡¹ç›®</category>
      
      <category domain="https://atong.run/categories/%E9%A1%B9%E7%9B%AE/%E9%AB%98%E5%B9%B6%E5%8F%91%E5%86%85%E5%AD%98%E6%B1%A0/">é«˜å¹¶å‘å†…å­˜æ± </category>
      
      
      <category domain="https://atong.run/tags/%E9%A1%B9%E7%9B%AE/">é¡¹ç›®</category>
      
      
      <comments>https://atong.run/posts/3511365265/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>obsidiançº¯ç²¹ç‰ˆæ’ä»¶æ¨è</title>
      <link>https://atong.run/posts/3017994336/</link>
      <guid>https://atong.run/posts/3017994336/</guid>
      <pubDate>Sun, 12 Feb 2023 14:24:55 GMT</pubDate>
      
        
        
      <description>&lt;p&gt;åªæ˜¯å•çº¯çš„è®°ç¬”è®°è€Œä¸æ˜¯æƒ³è¦all in oneï¼Œå»ºè®®åˆ«çœ‹å¤ªå¤šæ•™ç¨‹ï¼Œå¦åˆ™ä½ æŠ˜è…¾è¿™ä¸ªè½¯ä»¶çš„åŠŸå¤«å¾ˆæœ‰å¯èƒ½å¤§äºä½ è®°ç¬”è®°çš„åŠŸå¤«ï¼ˆæ— èŠç©éšæ„ï¼‰ï¼Œå¦‚æœæƒ³è¦å•çº¯çš„è·å¾—çº¯ç²¹ç‚¹çš„markdownè®°ç¬”è®°å¾€ä¸‹çœ‹ã€‚&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id=&quot;ä¸€ã€ä¸»é¢˜ç¯‡&quot;&gt;ä¸€ã€ä¸»é¢˜ç¯‡&lt;/h2&gt;
&lt;blockq</description>
        
      
      
      
      <content:encoded><![CDATA[<p>åªæ˜¯å•çº¯çš„è®°ç¬”è®°è€Œä¸æ˜¯æƒ³è¦all in oneï¼Œå»ºè®®åˆ«çœ‹å¤ªå¤šæ•™ç¨‹ï¼Œå¦åˆ™ä½ æŠ˜è…¾è¿™ä¸ªè½¯ä»¶çš„åŠŸå¤«å¾ˆæœ‰å¯èƒ½å¤§äºä½ è®°ç¬”è®°çš„åŠŸå¤«ï¼ˆæ— èŠç©éšæ„ï¼‰ï¼Œå¦‚æœæƒ³è¦å•çº¯çš„è·å¾—çº¯ç²¹ç‚¹çš„markdownè®°ç¬”è®°å¾€ä¸‹çœ‹ã€‚</p><hr><h2 id="ä¸€ã€ä¸»é¢˜ç¯‡">ä¸€ã€ä¸»é¢˜ç¯‡</h2><blockquote><p>é€‚å½“æŠ˜è…¾</p></blockquote><p>å»ºè®®ç›´æ¥é»˜è®¤å³å¯ï¼Œé»˜è®¤é£æ ¼å’Œgithub READMEã€å„ç§åšå®¢å¹³å°ï¼Œæ— å¤ªå¤šç¾åŒ–çš„ä¸ªäººåšå®¢é£æ ¼å·®ä¸å¤šï¼Œåˆ†äº«æ—¶ä¸ä¼šå·®å¤ªå¤§ã€‚</p><h2 id="äºŒã€æ’ä»¶ç¯‡">äºŒã€æ’ä»¶ç¯‡</h2><blockquote><p>å°‘æŠ˜è…¾ï¼Œè¿™é‡Œæ¨è5ä¸ªï¼Œèƒ½å¤Ÿå¸¦æ¥æœ€å•çº¯ç®€å•çš„ä½¿ç”¨markdownçš„ä½“éªŒï¼Œå¤§å®¶è°¨è®°æŠ˜è…¾è½¯ä»¶çš„åŠŸå¤«ä¸€å®šä¸è¦å¤§äºè®°ç¬”è®°çš„åŠŸå¤«</p></blockquote><h3 id="æ’ä»¶1ã€Recent-Files">æ’ä»¶1ã€Recent Files</h3><blockquote><p>è¿™ä¸ªæ’ä»¶å¾ˆå®ç”¨ï¼Œèƒ½çœ‹æœ€è¿‘æ‰“å¼€çš„æ–‡ç« </p></blockquote><p><img src="https://picx.zhimg.com/80/v2-2a43b3c2f87a0b4e2a0218a404be60e7_1440w.png" alt=""></p><h3 id="æ’ä»¶2ã€File-Explorer-Note-Count">æ’ä»¶2ã€File Explorer Note Count</h3><blockquote><p>èƒ½æ˜¾ç¤ºæ–‡ä»¶å¤¹ä¸‹è¾¹æœ‰å‡ ä¸ªæ–‡ä»¶</p></blockquote><p><img src="https://picx.zhimg.com/80/v2-c1070e27a0147824c27ff31952d04a79_1440w.png" alt=""></p><p>â€‹</p><h3 id="æ’ä»¶3ã€Editing-Toolbar">æ’ä»¶3ã€Editing Toolbar</h3><blockquote><p>éå¸¸å®ç”¨ï¼Œå°†å¸¸è§çš„markdownåŠŸèƒ½ï¼Œé›†æˆä¸ºä¸€ä¸ªå°å·¥å…·æ¡ï¼Œç±»ä¼¼wordçš„ä¸Šè¾¹å·¥å…·æ </p></blockquote><p><img src="https://picx.zhimg.com/80/v2-6e1c7066841550a84593ef45432964f3_1440w.png" alt=""></p><p>â€‹</p><h3 id="æ’ä»¶4ã€Advanced-Tables">æ’ä»¶4ã€Advanced Tables</h3><blockquote><p>obsidiançš„markdownè¡¨æ ¼æ¯”è¾ƒéš¾æ‰“ï¼Œè¿™ä¸ªæ˜¯å¢å¼ºè¾“å…¥è¡¨æ ¼åŠŸèƒ½çš„æ’ä»¶ï¼Œåªè¦è¾“å…¥ä¸€ä¸ª | åŠ å†…å®¹ç„¶åé…åˆå›è½¦å’Œtabé”®ï¼Œå°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„æå‡ºæ¥è¡¨æ ¼ï¼Œå½“ç„¶å®ƒä¹Ÿå¸¦äº†å·¥å…·æ </p></blockquote><p><img src="https://pic1.zhimg.com/80/v2-46d5ca49fae211260e450719d7bf198f_1440w.png" alt=""></p><p>â€‹</p><h3 id="æ’ä»¶5ã€Image-Auto-Upload-Plugin">æ’ä»¶5ã€Image Auto Upload Plugin</h3><blockquote><p>ä½¿ç”¨markdownå›¾åºŠè‚¯å®šå¾ˆé‡è¦ï¼Œæˆ‘ä»¬è‚¯å®šæœŸæœ›å¤åˆ¶å›¾ç‰‡åˆ°ç¬”è®°è½¯ä»¶ï¼Œå›¾ç‰‡å°±èƒ½è‡ªåŠ¨ä¸Šä¼ åˆ°å›¾åºŠï¼Œç„¶åç¬”è®°è½¯ä»¶é‡Œé¢æœ‰é“¾æ¥ï¼Œå¾ˆå¹¸è¿çš„æ˜¯obsidiané‡Œé¢æœ‰è¿™ä¸ªæ’ä»¶ï¼Œå’ŒPicGoé…åˆå°±å¯ä»¥åšåˆ°å•¦ï¼Œéå¸¸æ–¹ä¾¿</p></blockquote><p><img src="https://picx.zhimg.com/80/v2-b6b604e116dc13364e87b1164c0ef1b0_1440w.png" alt=""></p><p>â€‹</p><p><a href="https://post.smzdm.com/p/az6mokvo/">Obsidianå’Œpicgoå›¾ç‰‡è‡ªåŠ¨ä¸Šä¼ å›¾åºŠæ•™ç¨‹</a></p><h2 id="ä¸‰ã€æ€»ç»“">ä¸‰ã€æ€»ç»“</h2><p>åˆ‡è®°ï¼Œè®°ç¬”è®°æ‰æ˜¯æ­£é“ï¼Œåˆ«å…¥äº†æŠ˜è…¾è½¯ä»¶çš„å‘ï¼Œç„¶åå¦‚æœå«Œå¼ƒobsidianä¸‹è½½æ’ä»¶çš„ç½‘ç»œé—®é¢˜ï¼Œå¯ä»¥å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€å­™èœèœã€‘å›å¤ ã€obsidianã€‘å¯ä»¥è·å¾—ä¸Šè¾¹çš„äº”ä¸ªæ’ä»¶ã€‚</p><p><img src="https://pica.zhimg.com/80/v2-46fe8b8c98beb6661c01f6443788299b_1440w.png" alt=""></p><p>è¿™å‡ ä¸ªæ–‡ä»¶ç›´æ¥æ‹·è´åˆ° ä½ çš„ä»“åº“è·¯å¾„ä¸‹ \ .obsidian \ pluginsé‡Œé¢å³å¯ã€‚</p>]]></content:encoded>
      
      
      <category domain="https://atong.run/categories/%E5%B7%A5%E5%85%B7/">å·¥å…·</category>
      
      <category domain="https://atong.run/categories/%E5%B7%A5%E5%85%B7/obsidian/">obsidian</category>
      
      
      <category domain="https://atong.run/tags/%E7%AC%94%E8%AE%B0/">ç¬”è®°</category>
      
      
      <comments>https://atong.run/posts/3017994336/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>6ã€é«˜å¹¶å‘å†…å­˜æ± -PageCache</title>
      <link>https://atong.run/posts/2890609329/</link>
      <guid>https://atong.run/posts/2890609329/</guid>
      <pubDate>Fri, 10 Feb 2023 15:16:52 GMT</pubDate>
      
        
        
      <description>&lt;h1&gt;æ¡†æ¶ç»“æ„&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;central cacheå¯¹åº”çš„æ¡¶é‡Œå¦‚æœæ²¡æœ‰spanå¯¹è±¡ï¼Œéœ€è¦å‘page cacheå±‚ç”³è¯·ä¸€ä¸ªéç©ºçš„spanï¼Œpage cacheä¹Ÿæ˜¯å“ˆå¸Œæ¡¶çš„ç»“æ„ï¼ŒåŒæ ·é€šè¿‡åŒå‘é“¾è¡¨ç»„ç»‡ä¸€ä¸ªä¸ªçš„spanå¯¹è±¡ï¼Œä½†æ˜¯æ˜ å°„è§„åˆ™å’Œthread c</description>
        
      
      
      
      <content:encoded><![CDATA[<h1>æ¡†æ¶ç»“æ„</h1><blockquote><p>central cacheå¯¹åº”çš„æ¡¶é‡Œå¦‚æœæ²¡æœ‰spanå¯¹è±¡ï¼Œéœ€è¦å‘page cacheå±‚ç”³è¯·ä¸€ä¸ªéç©ºçš„spanï¼Œpage cacheä¹Ÿæ˜¯å“ˆå¸Œæ¡¶çš„ç»“æ„ï¼ŒåŒæ ·é€šè¿‡åŒå‘é“¾è¡¨ç»„ç»‡ä¸€ä¸ªä¸ªçš„spanå¯¹è±¡ï¼Œä½†æ˜¯æ˜ å°„è§„åˆ™å’Œthread cacheå’Œcentral cacheå±‚ä¸åŒï¼Œpage cacheçš„é€»è¾‘æŠ½è±¡ç»“æ„å¦‚ä¸‹ï¼š</p></blockquote><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302101543881.png" alt="33250a692c214c8286b38ba3c6c96847.png"></p><pre><code>page cacheé‡‡ç”¨ç›´æ¥å®šå€æ³•ï¼Œå‡ å·æ¡¶å°±æ˜¯æŒ‚çš„å‡ é¡µçš„spanï¼Œpagecheçš„spanå¯¹è±¡æ˜¯æŒ‰é¡µä¸ºå•ä½ï¼Œå¹¶æ²¡æœ‰åˆ‡åˆ†æˆå°å¯¹è±¡ï¼Œcentral cacheä¼šç”³è¯·å›ºå®šé¡µæ•°çš„spanï¼Œç„¶åè¿›è¡Œåˆ‡åˆ†</code></pre><h1>å…·ä½“å®ç°</h1><h2 id="page-cahe-ç±»">page cahe ç±»</h2><blockquote><p>page cache è¿™é‡Œè®¾è®¡spanæœ€å¤šæœ‰128é¡µï¼ˆ128 * 8 * 1024 = 1mï¼‰ï¼Œä¹Ÿå¯ä»¥æœ‰è®¾è®¡æˆå…¶ä»–å¤§å°ï¼Œæˆ‘ä»¬è®¾è®¡çš„thread cahcheå±‚æœ€å¤§ç”³è¯·256kbçš„å¯¹è±¡ï¼Œ128é¡µèƒ½åˆ‡æˆ4ä¸ªï¼Œç„¶åæˆ‘ä»¬è®©å‡ å·æ¡¶å¯¹åº”å‡ é¡µçš„spanï¼Œä¸ºäº†æ–¹ä¾¿æ•´ä¸ªpage cacheç±»è®¾è®¡ä¸º129ä¸ªæ¡¶ï¼Œç©ºå‡ºæ¥0å·æ¡¶</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// page cacheæ¡¶çš„ä¸ªæ•° - è¿™é‡Œè®¾ç½®ä¸º129ä¸ªï¼Œ0å·æ¡¶ä¸ç”¨</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">size_t</span> NPAGES = <span class="number">129</span>;</span><br></pre></td></tr></table></figure><blockquote><p>page cahceç±»åœ¨æ•´ä¸ªè¿›ç¨‹é‡Œåªæœ‰ä¸€ä¸ªï¼Œæˆ‘ä»¬åŒæ ·è®¾è®¡æˆå•ä¾‹æ¨¡å¼ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¤šä¸ªçº¿ç¨‹ç”³è¯·å¯¹è±¡ï¼Œthread cacheå±‚æ²¡æœ‰å†…å­˜éœ€è¦å‘central cacheç”³è¯·ï¼Œcentral cacheåªéœ€è¦åŠ æ¡¶é”å°±å¯ä»¥ï¼Œä½†æ˜¯page cacheæœ€å¥½æ•´ä¸ªåŠ é”ï¼Œå› ä¸ºpage cacheå¯èƒ½æ¶‰åŠåˆ°å¤šé¡µçš„spanåˆ‡åˆ†çš„é—®é¢˜ï¼Œå¹¶ä¸”å½“central cacheå½’è¿˜spanï¼Œpage cacheä¹Ÿä¼šå°è¯•å°†è¯¥spanå’Œå…¶ä»–æ¡¶çš„spanè¿›è¡Œåˆå¹¶ï¼Œè¿™æ ·å°±ä¼šè®¿é—®page cacheçš„å¤šä¸ªæ¡¶ï¼Œé€ æˆé¢‘ç¹çš„åŠ é”å’Œè§£é”ã€‚</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PageCache</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="comment">//æ•´ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä»½ï¼ŒåŒæ ·è®¾è®¡æˆå•ä¾‹æ¨¡å¼</span></span><br><span class="line"><span class="function"><span class="type">static</span> PageCache* <span class="title">GetInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> &amp;_sInst;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¦ä¸€ä¸ªké¡µçš„span</span></span><br><span class="line"><span class="function">Span* <span class="title">NewSpan</span><span class="params">(<span class="type">size_t</span> k)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">std::mutex _pageMtx;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="built_in">PageCache</span>() &#123;&#125;;</span><br><span class="line"><span class="built_in">PageCache</span>(<span class="type">const</span> PageCache&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">SpanList _spanLists[NPAGES];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> PageCache _sInst;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>ç±»å†…æä¾›ä¸€ä¸ªè·å–ké¡µspançš„æ¥å£</p></blockquote><h2 id="å®ç°é€»è¾‘">å®ç°é€»è¾‘</h2><blockquote><p>æˆ‘ä»¬å…ˆç»§ç»­å®Œå–„centralå±‚çš„é€»è¾‘ï¼Œä¸ŠèŠ‚è¯´ä»ä¸­å¿ƒç¼“å­˜è·å–ä¸€å®šæ•°é‡çš„å¯¹è±¡ç»™thread cacheï¼Œç”¨äº†ä¸€ä¸ªFatchRangeObjçš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„å†…éƒ¨ï¼Œé¦–å…ˆè¦ä¿è¯CentralCacheå±‚æœ‰ä¸€ä¸ªéç©ºçš„spanï¼Œé‚£ä¹ˆå¦‚ä½•ä¿è¯æœ‰ä¸€ä¸ªéç©ºçš„spanå‘¢ï¼Ÿå¤§è‡´æ€è·¯æ˜¯å…ˆä»central cacheå¯¹åº”çš„æ¡¶é‡Œæ‰¾ï¼Œå¦‚æœæ²¡æœ‰å°±å¾€ä¸‹æ‰¾Page Cacheå±‚è¦ã€‚</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–ä¸€ä¸ªéç©ºçš„span</span></span><br><span class="line"><span class="function">Span* <span class="title">CentralCache::GetOneSpan</span><span class="params">(SpanList&amp; list, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><pre><code>æˆ‘ä»¬ç»§ç»­å®Œå–„è¿™ä¸ªå‡½æ•°</code></pre><blockquote><p>æ­¥éª¤1ã€å…ˆå»size å¯¹åº”çš„æ¡¶é‡Œæ‰¾éç©ºçš„spanï¼Œè¿™é‡Œæ¶‰åŠåˆ°é“¾è¡¨çš„éå†æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥å®Œå–„ä¸€ä¸‹SpanListç±»ï¼Œæä¾›ç›¸åº”çš„æ¥å£æ–¹ä¾¿æˆ‘ä»¬æ“ä½œ</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨spanlistç±»ä¸­å¢åŠ ä¸€ä¸‹å‡½æ•°ï¼Œæ–¹ä¾¿éå†æ“ä½œ</span></span><br><span class="line"><span class="function">Span* <span class="title">Begin</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> _head-&gt;_next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Span* <span class="title">End</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> _head;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Empty</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> _head == _head-&gt;_next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ­¥éª¤2ã€è‹¥æœ‰éç©ºçš„spanç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æœ‰ï¼Œéœ€è¦å‘ä¸‹ä¸€å±‚çš„PageCacheç”³è¯·æ–°çš„ä¸€é¡µSpanï¼Œè¿™é‡Œæˆ‘ä»¬æ¶‰åŠåˆ°åŠ é”ã€è§£é”è¿‡ç¨‹ï¼Œä»¥åŠå¦‚æœå‘ä¸‹ä¸€å±‚ç”³è¯·SPanå…·ä½“æ˜¯è¦å¤šä¸ªå°‘é¡µå‘¢ï¼Ÿ</p></blockquote><pre><code>æˆ‘ä»¬å¯ä»¥å…ˆè§£å†³è¦å¤šå°‘é¡µçš„é—®é¢˜ï¼Œåœ¨SizeClassç±»ä¸­å¢åŠ NumMovePageå‡½æ•°</code></pre><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¡ç®—ä¸€æ¬¡å‘ç³»ç»Ÿè·å–å¤šå°‘ä¸ªé¡µ</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">size_t</span> <span class="title">NumMovePage</span><span class="params">(<span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// å…ˆè·å–ç”³è¯·sizeå¯¹è±¡å¤§å°çš„ä¸Šé™(å°½å¯èƒ½å¤šè¦ä¸€äº›)</span></span><br><span class="line"><span class="type">size_t</span> num = <span class="built_in">NumMoveSize</span>(size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç®—ä¸€ä¸‹numä¸ªå¯¹è±¡æ€»å…±å¤šå°‘å­—èŠ‚ï¼Œç„¶åå³ç§»13ä½å°±æ˜¯å¤šå°‘é¡µ</span></span><br><span class="line"><span class="type">size_t</span> npage = (num * size) &gt;&gt; PAGE_SHITF;</span><br><span class="line"><span class="comment">// æœ€å°‘ç”³è¯·1é¡µ</span></span><br><span class="line"><span class="keyword">if</span> (npage == <span class="number">0</span>)</span><br><span class="line">npage = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">return</span> npage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ­¥éª¤3ã€ç”³è¯·å®Œspanåï¼Œå°±è¦å°†é‡Œé¢çš„å¤§å—å†…å­˜è¿›è¡Œåˆ‡åˆ†ï¼Œæˆ‘ä»¬éœ€è¦ç›´åˆ°å¤§å—å†…å­˜çš„èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€ï¼Œä¸æ–­çš„åˆ‡æˆsizeå¤§å°è¿›è¡Œå°¾æ’ï¼Œè¿™é‡Œå°¾æ’æœ‰ä¸ªå¥½å¤„ï¼Œå®ƒçš„ç‰©ç†åœ°å€æ˜¯è¿ç»­çš„ï¼Œå½“è¢«çº¿ç¨‹ä½¿ç”¨æ—¶ï¼Œå¯ä»¥æé«˜çº¿ç¨‹çš„CPUç¼“å­˜åˆ©ç”¨ç‡</p></blockquote><blockquote><p>GetOneSpanæ•´ä½“ä»£ç </p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–ä¸€ä¸ªéç©ºçš„span</span></span><br><span class="line"><span class="function">Span* <span class="title">CentralCache::GetOneSpan</span><span class="params">(SpanList&amp; list, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// 1ã€å…ˆå»size å¯¹åº”çš„æ¡¶é‡Œæ‰¾éç©ºçš„span</span></span><br><span class="line">Span* it = list.<span class="built_in">Begin</span>();</span><br><span class="line"><span class="keyword">while</span> (it != list.<span class="built_in">End</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (it-&gt;_freeList != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> it;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">it = it-&gt;_next;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œå¯ä»¥å…ˆå°†è¿™ä¸ªæ¡¶çš„æ¡¶é”è¿›è¡Œè§£é”ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥é‡Šæ”¾å†…å­˜å¯¹è±¡å›æ¥ä¸ä¼šé˜»å¡</span></span><br><span class="line">list._mtx.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ°è¿™é‡Œè¯´æ˜ï¼Œsizeå¯¹åº”çš„CentralCacheå±‚é‡Œé¢æ²¡æœ‰Spanå¯¹è±¡ï¼Œé‚£ä¹ˆéœ€è¦å‘ä¸‹ä¸€å±‚ç”³è¯·</span></span><br><span class="line"><span class="comment">// å…ˆè¿›è¡Œæ•´ä¸ªpage cacheå±‚çš„åŠ é”</span></span><br><span class="line">PageCache::<span class="built_in">GetInstance</span>()-&gt;_pageMtx.<span class="built_in">lock</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ‘ä»¬è¦è®¡ç®—å‘page cacheå±‚è¦å¤šå°‘é¡µçš„span</span></span><br><span class="line">Span* span = PageCache::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">NewSpan</span>(SizeClass::<span class="built_in">NumMovePage</span>(size));</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£é”</span></span><br><span class="line">PageCache::<span class="built_in">GetInstance</span>()-&gt;_pageMtx.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”³è¯·å›æ¥çš„spanå¯¹è±¡è¿›è¡Œåˆ‡åˆ†ï¼Œè¿™ä¼šä¸éœ€è¦åŠ é”ï¼Œå› ä¸ºè¿™ä¼šå…¶ä»–çº¿ç¨‹è®¿é—®ä¸åˆ°è¿™ä¸ªspanï¼ˆè¿˜æ²¡æŒ‚åˆ°spanListsï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¦è®¡ç®—spançš„å¤§å—å†…å­˜çš„èµ·å§‹åœ°å€å’Œå¤§å—å†…å­˜çš„å¤§å°</span></span><br><span class="line"><span class="comment">// é¡µå·å·¦ç§»PAGE_SHIFTå°±æ˜¯åœ°å€</span></span><br><span class="line"><span class="type">char</span>* start = (<span class="type">char</span>*)(span-&gt;_pageId &lt;&lt; PAGE_SHITF);</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> bytes = span-&gt;_n &lt;&lt; PAGE_SHITF;</span><br><span class="line"><span class="type">char</span>* end = start + bytes;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…ˆåˆ‡ä¸€å—åšå¤´</span></span><br><span class="line">span-&gt;_freeList = start;</span><br><span class="line">start += size;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿›è¡Œå°¾æ’</span></span><br><span class="line"><span class="type">void</span>* tail = span-&gt;_freeList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(start &lt;end)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">NextObj</span>(tail) = start;</span><br><span class="line">tail = <span class="built_in">NextObj</span>(tail);</span><br><span class="line">start += size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ‡å¥½spanï¼Œå°†spanæŒ‚åˆ°æ¡¶é‡Œï¼ŒåŠ é”</span></span><br><span class="line">list._mtx.<span class="built_in">lock</span>();</span><br><span class="line">list.<span class="built_in">PushFront</span>(span);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> span;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å®Œæˆä¸Šè¾¹çš„ä»£ç åæˆ‘ä»¬çœ‹çœ‹åº•å±‚çš„PageCache::NewSpan(size_t k) ï¼Œæˆ‘ä»¬è¿™ä¸ªè·å–ä¸€ä¸ªNewSpançš„å¤§è‡´é€»è¾‘ä¸ºï¼šé¦–å…ˆæ£€æŸ¥ç¬¬kä¸ªæ¡¶é‡Œæœ‰æ²¡æœ‰spanï¼Œå¦‚æœæ²¡æœ‰ï¼Œå‘åè¾¹çš„æ¡¶æ‰¾æ›´å¤§çš„Spanï¼Œç„¶ååˆ†æˆkå’Œn-kï¼Œè¿”å›ké¡µçš„Spanï¼Œn-ké¡µçš„SpanæŒ‚åˆ°ç›¸åº”çš„æ¡¶é‡Œ</p></blockquote><hr><blockquote><p>æ­¥éª¤1ã€åˆ¤æ–­kä¸ªæ¡¶æœ‰æ²¡æœ‰spanå¦‚æœæœ‰ï¼Œè¿”å›å¤´ä¸Šé‚£ä¸ªï¼Œè¿™æ—¶å€™éœ€è¦åœ¨åœ¨SpanListç±»é‡Œé¢æä¾›ä¸€ä¸ªPopFrontå‡½æ•°ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿæä¾›ä¸€ä¸ªPushFrontçš„å‡½æ•°ï¼Œæ–¹ä¾¿ä¹‹åçš„æ“ä½œ</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤´åˆ è¿”å›</span></span><br><span class="line"><span class="function">Span* <span class="title">PopFront</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Span* sp = _head-&gt;_next;</span><br><span class="line"><span class="comment">/*head-&gt;_next = sp-&gt;_next;</span></span><br><span class="line"><span class="comment">sp-&gt;_next = nullptr;</span></span><br><span class="line"><span class="comment">return sp;*/</span></span><br><span class="line"><span class="built_in">Erase</span>(sp);</span><br><span class="line"><span class="keyword">return</span> sp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤´æ’</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PushFront</span><span class="params">(Span* span)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">Insert</span>(<span class="built_in">Begin</span>(), span);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ­¥éª¤2ã€å¦‚æœæ²¡æœ‰ï¼Œéå†åé¢çš„æ¡¶ï¼Œå¦‚æœæœ‰ï¼Œå°±åˆ‡æˆkå’Œn-kï¼Œè¿”å›ké¡µçš„spanï¼Œn-ké¡µçš„spanæ’å…¥åˆ°å¯¹åº”çš„æ¡¶</p></blockquote><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302102055998.png" alt="image.png"></p><blockquote><p>æ­¥éª¤3ã€å¦‚æœä»k+1åˆ°NPAGES-1æ¡¶éƒ½æ²¡æœ‰spanï¼Œé‚£ä¹ˆåªèƒ½é€šè¿‡ç³»ç»Ÿè°ƒç”¨å‘å †ç”³è¯·ï¼Œè¿™é‡Œç›´æ¥ç”³è¯·128é¡µçš„spanï¼Œç”³è¯·æˆåŠŸåï¼Œè¿˜æ˜¯èµ°æ­¥éª¤2çš„é€»è¾‘ï¼Œå¯ä»¥ç›´æ¥é€’å½’å¤„ç†</p></blockquote><blockquote><p>æ•´ä½“ä»£ç </p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// page cache è¿”å›ä¸€ä¸ªspan</span></span><br><span class="line"><span class="function">Span* <span class="title">PageCache::NewSpan</span><span class="params">(<span class="type">size_t</span> k)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// å…ˆæ–­è¨€ä¸€ä¸‹</span></span><br><span class="line"><span class="built_in">assert</span>(k &gt; <span class="number">0</span> &amp;&amp; k &lt; NPAGES);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…ˆæ£€æŸ¥ç¬¬kä¸ªæ¡¶é‡Œæœ‰æ²¡æœ‰Span</span></span><br><span class="line"><span class="keyword">if</span> (!_spanLists[k].<span class="built_in">Empty</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// å¤´åˆ ç¬¬ä¸€ä¸ªè¿”å›è¿™é‡Œå»å®ç°PopFrontçš„é€»è¾‘</span></span><br><span class="line"><span class="keyword">return</span> _spanLists[k].<span class="built_in">PopFront</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¦‚æœkå·æ¡¶ä¸ºç©ºï¼Œæ£€æŸ¥åé¢çš„æ¡¶ï¼Œæ‰¾åˆ°ä¸€ä¸ªéç©ºæ¡¶ï¼Œç›´åˆ°æœ€åä¸€ä¸ªæ¡¶</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = k + <span class="number">1</span>; i &lt; NPAGES; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!_spanLists[i].<span class="built_in">Empty</span>())</span><br><span class="line">&#123;</span><br><span class="line">Span* nSpan = _spanLists[i].<span class="built_in">PopFront</span>();</span><br><span class="line"><span class="comment">// ï¼Ÿ</span></span><br><span class="line">Span* kSpan = <span class="keyword">new</span> Span;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†æˆnpan åˆ†ä¸€ä¸ª ké¡µè¿”å›ï¼Œç„¶ån-ké¡µçš„spanæŒ‚åˆ°n-kçš„æ¡¶ä¸Š</span></span><br><span class="line"><span class="comment">// è¿™é‡Œæ³¨æ„ï¼Œåªéœ€è¦æ”¹é¡µå·å’Œé¡µæ•°å°±å¯ä»¥äº†ï¼ŒspanæŒ‚çš„å†…å­˜çš„åœ°å€æŒ‰é¡µå·å–</span></span><br><span class="line">kSpan-&gt;_pageId = nSpan-&gt;_pageId;</span><br><span class="line">kSpan-&gt;_n = k;</span><br><span class="line"></span><br><span class="line">nSpan-&gt;_n -= k;</span><br><span class="line">nSpan-&gt;_pageId += k;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_spanLists[nSpan-&gt;_n].<span class="built_in">PushFront</span>(nSpan);</span><br><span class="line"><span class="keyword">return</span> kSpan;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ°è¿™é‡Œè¯´æ˜åé¢çš„æ‰€æœ‰ä½ç½®éƒ½æ²¡æœ‰å¤§é¡µçš„span</span></span><br><span class="line"><span class="comment">// è¿™æ—¶å€™å°±éœ€è¦å‘å †ç”³è¯·ä¸€ä¸ª128é¡µçš„span</span></span><br><span class="line">Span* bigSpan = <span class="keyword">new</span> Span;</span><br><span class="line"><span class="type">void</span>* ptr = <span class="built_in">SystemAlloc</span>(NPAGES<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bigSpan-&gt;_n = NPAGES - <span class="number">1</span>;</span><br><span class="line">bigSpan-&gt;_pageId = (PAGE_ID)ptr &gt;&gt; PAGE_SHITF;</span><br><span class="line"></span><br><span class="line">_spanLists[bigSpan-&gt;_n].<span class="built_in">PushFront</span>(bigSpan);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">NewSpan</span>(k);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œæ³¨æ„æœ€åå‡ å¥çš„é€»è¾‘ï¼Œæˆ‘ä»¬ç”³è¯·äº†128é¡µçš„å†…å­˜ï¼Œè¿”å›äº†èµ·å§‹çš„æŒ‡é’ˆptrï¼Œå°†è¿™ä¸ªåœ°å€è½¬æˆæ•´å½¢ï¼Œå³ç§»PAGE_SHIFTä½ï¼Œç›¸å½“äºé™¤ä»¥2^13ï¼Œå°±æ˜¯ç®¡ç†è¿™å—å¤§å—å†…å­˜çš„spançš„é¡µå·</p></blockquote><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302102010347.png" alt="image.png"></p>]]></content:encoded>
      
      
      <category domain="https://atong.run/categories/%E9%A1%B9%E7%9B%AE/">é¡¹ç›®</category>
      
      <category domain="https://atong.run/categories/%E9%A1%B9%E7%9B%AE/%E9%AB%98%E5%B9%B6%E5%8F%91%E5%86%85%E5%AD%98%E6%B1%A0/">é«˜å¹¶å‘å†…å­˜æ± </category>
      
      
      <category domain="https://atong.run/tags/%E9%A1%B9%E7%9B%AE/">é¡¹ç›®</category>
      
      
      <comments>https://atong.run/posts/2890609329/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>5ã€é«˜å¹¶å‘å†…å­˜æ± -CentralCache</title>
      <link>https://atong.run/posts/1806624746/</link>
      <guid>https://atong.run/posts/1806624746/</guid>
      <pubDate>Wed, 08 Feb 2023 15:12:01 GMT</pubDate>
      
        
        
      <description>&lt;h1&gt;Central Cacheæ¡†æ¶è®¾è®¡&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;å½“ç”³è¯·å¯¹è±¡æ—¶ï¼Œthread cacheå±‚å¯¹åº”çš„è‡ªç”±é“¾è¡¨ä¸ºç©ºæ—¶ï¼Œéœ€è¦å‘central cacheå±‚ç”³è¯·å†…å­˜ã€‚central cacheå±‚æ¡†æ¶å›¾å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;i</description>
        
      
      
      
      <content:encoded><![CDATA[<h1>Central Cacheæ¡†æ¶è®¾è®¡</h1><blockquote><p>å½“ç”³è¯·å¯¹è±¡æ—¶ï¼Œthread cacheå±‚å¯¹åº”çš„è‡ªç”±é“¾è¡¨ä¸ºç©ºæ—¶ï¼Œéœ€è¦å‘central cacheå±‚ç”³è¯·å†…å­˜ã€‚central cacheå±‚æ¡†æ¶å›¾å¦‚ä¸‹ï¼š</p></blockquote><p><img src="https://tong-1306822294.cos.ap-beijing.myqcloud.com/tong/picture/202302081948813.png" alt="9d6481a02fe24f458b37909674fc3d66.png"></p><p>central cacheæ•´ä½“ä¹Ÿæ˜¯ä¸€ä¸ªå“ˆå¸Œæ¡¶ç»“æ„ï¼Œç±»ä¼¼äºthread cacheå±‚ï¼Œä½†æ˜¯central cacheå±‚æ‰€æŒ‚çš„æ˜¯spançš„é“¾è¡¨</p><ul><li>spanæ˜¯ç®¡ç†å¤§å—å†…å­˜çš„æ•°æ®ç»“æ„ï¼Œé¡µä¸ºå•ä½</li><li>spané‡Œé¢æœ‰ä¸ªè‡ªç”±é“¾è¡¨ï¼Œç®¡ç†åˆ‡å‰²å‡ºæ¥çš„å°å†…å­˜å—</li><li>æ˜ å°„å…³ç³»å’Œå¯¹é½è§„åˆ™åŒthread cache</li></ul><h1>Central Cacheå…·ä½“ç»“æ„</h1><h2 id="spanç»“æ„">spanç»“æ„</h2><blockquote><p>spanæ˜¯ç®¡ç†å¤šä¸ªè¿ç»­é¡µå¤§å—å†…å­˜çš„è·¨åº¦ç»“æ„ï¼Œå…·ä½“ç»“æ„ä»£ç å¦‚ä¸‹ï¼›</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Span</span></span><br><span class="line">&#123;</span><br><span class="line">PAGE_ID _pageId = <span class="number">0</span>; <span class="comment">//å¤§å—å†…å­˜èµ·å§‹é¡µçš„é¡µå·</span></span><br><span class="line"><span class="type">size_t</span> _n = <span class="number">0</span>; <span class="comment">//é¡µçš„æ•°é‡</span></span><br><span class="line"></span><br><span class="line">Span* _next = <span class="literal">nullptr</span>; <span class="comment">//åŒå‘é“¾è¡¨çš„ç»“æ„</span></span><br><span class="line">Span* _prev = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> _useCount = <span class="number">0</span>; <span class="comment">//åˆ‡å¥½çš„å°å—å†…å­˜ï¼Œè¢«åˆ†é…ç»™thread cacheçš„è®¡æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* _freeList =<span class="literal">nullptr</span>; <span class="comment">//åˆ‡å¥½å°å—å†…å­˜çš„è‡ªç”±é“¾è¡¨</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é¦–å…ˆéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œspanæ˜¯åŒå‘é“¾è¡¨çš„ç»“æ„ï¼ŒåŒå‘é“¾è¡¨åˆ é™¤å…ƒç´ éå¸¸æ–¹ä¾¿ï¼Œå½“å°†æŸä¸ªspanå¯¹è±¡å½’è¿˜ç»™page cacheå±‚æ—¶ï¼ŒåŒå‘é“¾è¡¨åˆ é™¤éå¸¸ç®€å•</p><blockquote><p>spanæ˜¯ç®¡ç†ä»¥é¡µä¸ºå•ä½çš„å¤§å—å†…å­˜ï¼Œå½“å½’è¿˜ç»™page cacheå±‚æ—¶ï¼Œä¸ºäº†æ–¹ä¾¿ç›¸é‚»é¡µçš„åˆå¹¶éœ€è¦ä¸€ä¸ªé¡µå· pageIDï¼Œæˆ‘ä»¬ç”¨äº†typedefçš„ç±»å‹PAGE_ID</p></blockquote><pre><code>å‡è®¾ä¸€é¡µä¸º8k32ä½ä¸‹ è¿›ç¨‹åœ°å€ç©ºé—´æœ‰4Gï¼Œèƒ½åˆ† 2^32/2^13 = 2^19 ä¸ªé¡µ64ä½ä¸‹ è¿›ç¨‹åœ°å€ç©ºé—´æœ‰16Gï¼Œèƒ½åˆ† 2^64/2^13 = 2^51 ä¸ªé¡µ</code></pre><p>æ‰€ä»¥ä¸åŒå¹³å°ä¸‹ï¼ŒPAGE_ID çš„ç±»å‹éœ€è¦åŠ¨æ€è°ƒæ•´ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨æ¡ä»¶ç¼–è¯‘å®ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//x64  _WIN32å’Œ_WIN64éƒ½æœ‰å®šä¹‰</span></span><br><span class="line"><span class="comment">//win32 _WIN32æœ‰å®šä¹‰ï¼Œ_WIN64æ²¡æœ‰å®šä¹‰</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> PAGE_ID;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> _WIN32</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">size_t</span> PAGE_ID;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _WIN64</span></span></span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œæ³¨æ„å…ˆåˆ¤æ–­ _WIN64</p></blockquote><h2 id="SpanListç»“æ„">SpanListç»“æ„</h2><blockquote><p>æˆ‘ä»¬çŸ¥é“central cacheå±‚æ¯ä¸ªå“ˆå¸Œæ¡¶ä¸­æŒ‚çš„æ˜¯spançš„é“¾è¡¨ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªé“¾è¡¨ç»“æ„å®šä¹‰æˆå¸¦å¤´åŒå‘çš„å¾ªç¯é“¾è¡¨</p></blockquote><p>æˆ‘ä»¬ç›®å‰çš„æ ¸å¿ƒæˆå‘˜æœ‰ä¸¤ä¸ª</p><ul><li>Span*</li><li>mutexé”ï¼ˆæ¡¶é”ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶ç”³è¯·ä¸€ä¸ªæ¡¶çš„å¯¹è±¡æ—¶éœ€è¦åŠ é”ï¼‰</li></ul><p>æä¾›ï¼Œæ’å…¥å’Œåˆ é™¤å’Œåˆ é™¤çš„æ¥å£</p><ul><li><code>void Insert(Span* pos, Span* newSpan)</code></li><li><code>void Eerase(Span *pos)</code></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SpanList</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">SpanList</span>()</span><br><span class="line">&#123;</span><br><span class="line">_head = <span class="keyword">new</span> Span;</span><br><span class="line">_head-&gt;_next = _head;</span><br><span class="line">_head-&gt;_prev = _head;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Insert</span><span class="params">(Span* pos, Span* newSpan)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// å…ˆæ–­è¨€ä¸€ä¸‹æœ‰æ²¡æœ‰é—®é¢˜</span></span><br><span class="line"><span class="built_in">assert</span>(pos);</span><br><span class="line"><span class="built_in">assert</span>(newSpan);</span><br><span class="line"></span><br><span class="line">Span* prev = pos-&gt;_prev;</span><br><span class="line">newSpan-&gt;_next = pos;</span><br><span class="line">pos-&gt;_prev = newSpan;</span><br><span class="line"></span><br><span class="line">prev-&gt;_next = newSpan;</span><br><span class="line">newSpan-&gt;_prev = prev;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Eerase</span><span class="params">(Span *pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">assert</span>(pos);</span><br><span class="line"><span class="built_in">assert</span>(pos != _head);</span><br><span class="line"></span><br><span class="line">Span* prev = pos-&gt;_prev;</span><br><span class="line">Span* next = pos-&gt;_next;</span><br><span class="line"></span><br><span class="line">next-&gt;_prev = prev;</span><br><span class="line">prev-&gt;_next = next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">Span* _head;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">std::mutex _mtx; <span class="comment">//æ¡¶é”</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼Œeraseæ—¶ï¼Œä¸éœ€è¦deleteï¼Œåªéœ€è¦ä»é“¾è¡¨ç§»é™¤å³å¯ï¼Œä¼šå½’è¿˜ç»™ä¸‹ä¸€å±‚çš„page cache</p></blockquote><h2 id="Central-Cacheç»“æ„">Central Cacheç»“æ„</h2><blockquote><p>é¦–å…ˆCentral Cacheæ˜¯å“ˆå¸Œæ¡¶ç»“æ„ï¼Œç„¶åæˆ‘ä»¬æœŸæœ›ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å±äºè‡ªå·±çš„Thread Cacheï¼ˆç”¨TLSå®ç°æ— é”ï¼‰ï¼Œä½†æ˜¯Central Cacheåœ¨æ•´ä¸ªè¿›ç¨‹ä¸­åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¾è®¡æˆå•ä¾‹æ¨¡å¼</p></blockquote><pre><code>å•ä¾‹æ¨¡å¼é‡‡ç”¨é¥¿æ±‰æ¨¡å¼ï¼Œæ„é€ å‡½æ•°ç§æœ‰ï¼Œåœ¨é™æ€åŒºåˆ›å»ºä¸€ä¸ªå¯¹è±¡</code></pre><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å•ä¾‹æ¨¡å¼</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CentralCache</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="type">static</span> CentralCache* <span class="title">GetInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> &amp;_sInst;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ¥å£ï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">static</span> CentralCache _sInst;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="built_in">CentralCache</span>()&#123;&#125; <span class="comment">//æ„é€ å‡½æ•°ç§æœ‰åŒ–</span></span><br><span class="line"><span class="built_in">CentralCache</span>(<span class="type">const</span> CentralCache&amp; c) = <span class="keyword">delete</span>; <span class="comment">//ç¦ç”¨æ‹·è´</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">SpanList _spanLists[NFREELIST]; <span class="comment">// SpanListæ•°ç»„ï¼ˆå“ˆå¸Œæ¡¶ï¼‰</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1>Central Cacheé€»è¾‘å®ç°</h1><blockquote><p>thread cacheå±‚ï¼Œç”³è¯·å¯¹è±¡ï¼Œå¯¹åº”è‡ªç”±é“¾è¡¨ä¸ºç©ºæ—¶ï¼Œéœ€è¦å‘central cacheå±‚ç”³è¯·å†…å­˜ï¼Œæˆ‘ä»¬åœ¨thread cacheéƒ¨åˆ†æä¾›äº†ä¸€ä¸ªæ¥å£FetchFromCentralCacheï¼Œæˆ‘ä»¬å…ˆä»è¿™é‡Œå¼€å§‹ï¼Œé€æ­¥æ‰©å±•åˆ°æ•´ä½“çš„central cacheçš„é€»è¾‘å®ç°</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä»ä¸­å¿ƒç¼“å­˜è·å–å¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">ThreadCache::FetchFromCentralCache</span><span class="params">(<span class="type">size_t</span> index, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>thread cacheå‘centralç”³è¯·å†…å­˜æ—¶ï¼Œæœ€å¥½å¤šç»™ä¸€äº›ï¼Œé¿å…é¢‘ç¹ç”³è¯·ï¼Œé‚£ä¹ˆè¯¥ç»™å¤šå°‘æ¯”è¾ƒåˆé€‚å‘¢ï¼Ÿè¿™é‡Œæå‡ºä¸€ä¸ªæ…¢å¼€å§‹åé¦ˆç®—æ³•ï¼Œæˆ‘ä»¬æ ¸å¿ƒæƒ³æ³•å¦‚ä¸‹ï¼š</p></blockquote><ol><li>æœ€å¼€å§‹ä¸ä¼šä¸€æ¬¡å‘central cacheä¸€æ¬¡æ‰¹é‡çš„è¦å¤ªå¤šï¼Œè¦å¤ªå¤šå¯èƒ½ä¼šç”¨ä¸å®Œ</li><li>å¦‚æœä¸æ–­æœ‰è¦sizeå¤§å°å†…å­˜çš„çš„éœ€æ±‚ï¼ŒbatchNumä¹Ÿä¼šä¸æ–­çš„å¢é•¿ç›´åˆ°ä¸Šé™</li><li>sizeè¶Šå¤§ï¼Œä¸€æ¬¡å‘central cacheè¦çš„batchNumè¶Šå°</li><li>sizeè¶Šå°ï¼Œä¸€æ¬¡å‘central cacheè¦çš„batchNumè¶Šå¤§ã€‚</li></ol><blockquote><p>æ ¹æ®ä¸Šè¿°è§„åˆ™ï¼Œæˆ‘ä»¬åœ¨SizeClassç±»å¢åŠ ä¸‹è¿°å‡½æ•°</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸€æ¬¡thread cacheä»ä¸­å¿ƒèŠ‚ç‚¹è·å–å¤šå°‘ä¸ª</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">size_t</span> <span class="title">NumMoveSize</span><span class="params">(<span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">assert</span>(size &gt; <span class="number">0</span>);</span><br><span class="line"><span class="type">size_t</span> num = MAX_BYTES / size;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸€æ¬¡æ‰¹é‡ç§»åŠ¨å¤šå°‘ä¸ªå¯¹è±¡çš„(æ…¢å¯åŠ¨)ä¸Šé™å€¼ä¸º[2,512]</span></span><br><span class="line"><span class="comment">// å°å¯¹è±¡ä¸€æ¬¡æ‰¹é‡ä¸Šé™é«˜</span></span><br><span class="line"><span class="comment">// å¤§å¯¹è±¡ä¸€æ¬¡æ‰¹é‡ä¸Šé™ä½</span></span><br><span class="line"><span class="keyword">if</span> (num &lt; <span class="number">2</span>)</span><br><span class="line">num = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">if</span> (num &gt; <span class="number">512</span>)</span><br><span class="line">num = <span class="number">512</span>;</span><br><span class="line"><span class="keyword">return</span> num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æˆ‘ä»¬å°±å¯ä»¥åœ¨FetchFromCentralCacheå‡½æ•°ä¸­è°ƒç”¨ä¸Šé¢å‡½æ•°è·å–åº”è¯¥ç»™central cacheæ‰¹é‡å±‚è¦å¤šå°‘ä¸ªå¯¹è±¡çš„ä¸ªæ•°</p></blockquote> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> batchNum = SizeClass::<span class="built_in">NumMoveSize</span>(size);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è‹¥sizeæ¯”è¾ƒå°ï¼ŒbatchNumåˆšå¼€å§‹çš„æ—¶å€™è¿˜æ˜¯æ¯”è¾ƒå¤§ï¼Œæ€ä¹ˆè®©å°å¯¹è±¡å®ƒå¼€å§‹çš„æ—¶å€™ä¹Ÿæ²¡é‚£ä¹ˆå¤§ï¼Œæ»¡è¶³è§„åˆ™2å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥è¿™æ ·å¤„ç†ï¼Œåœ¨FreeListç»“æ„ä¸­ï¼Œå¢åŠ ä¸€ä¸ªæˆå‘˜ _ maxSizeï¼Œå¹¶åˆå§‹åŒ–ä¸º1ï¼Œè¿™æ ·thread cacheå±‚æ¯ä¸€ä¸ªæ¡¶çš„è‡ªç”±é“¾è¡¨éƒ½æœ‰å®ƒçš„maxSizeã€‚å¹¶å¯ä»¥å†™ä¸‹è¾¹çš„é€»è¾‘ã€‚</p><pre><code>å½“batchNumå’Œå½“å‰æ‰€åœ¨è‡ªç”±é“¾è¡¨çš„MaxSizeç›¸åŒæ—¶ï¼Œè¯´æ˜ä¸Šè¾¹MaxSizeæ˜¯è¾ƒå°çš„é‚£ä¸ªï¼Œæˆ‘ä»¬è®©MaxSizeåŠ 1ï¼Œè‹¥ä¸æ–­ç”³è¯·sizeå¤§å°çš„å¯¹è±¡ï¼ŒMaxSizeå°±ä¼šä¸æ–­å¢å¤§ï¼Œè€Œã€2ï¼Œ512ã€‘å°±å¯ä»¥åšè¿™ä¸ªå¢åŠ çš„ä¸Šé™</code></pre><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> batchNum = std::<span class="built_in">min</span>(SizeClass::<span class="built_in">NumMoveSize</span>(size),_freeLists[index].<span class="built_in">MaxSize</span>());</span><br><span class="line"><span class="keyword">if</span> (_freeLists[index].<span class="built_in">MaxSize</span>() == batchNum)</span><br><span class="line">&#123;</span><br><span class="line">_freeLists[index].<span class="built_in">MaxSize</span>() += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>çŸ¥é“è¦å¤šå°‘ä¸ªå¯¹è±¡åå°±å‘central cacheå±‚è¦batchNumä¸ªå¯¹è±¡ï¼Œä½†æ˜¯è¿™é‡Œå°±ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œcentral cacheå±‚å¯èƒ½ä¸å¤ŸbatchNumä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬çœ‹ä¸‹è¾¹å¤„ç†</p></blockquote><pre><code>é¦–å…ˆæ˜¯ç»™CentralCacheç±»æä¾›ä¸¤ä¸ªæ¥å£ã€‚ä¸€ä¸ªæ˜¯è·å–éç©ºçš„Spanï¼Œå¦ä¸€ä¸ªå°±æ˜¯è·å–batchNumä¸ªå¯¹è±¡</code></pre><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»ä¸­å¿ƒç¼“å­˜è·å–ä¸€å®šæ•°é‡çš„å¯¹è±¡ç»™thread cache</span></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">CentralCache::FetchRangeObj</span><span class="params">(<span class="type">void</span>*&amp; start, <span class="type">void</span>*&amp; end, <span class="type">size_t</span> batchNum, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// å…ˆç®—sizeå¤§å°çš„å¯¹è±¡ï¼Œå¯¹åº”å“ªä¸ªæ¡¶ï¼Œç„¶åå°±å»å“ªä¸ªæ¡¶å»ç”³è¯·</span></span><br><span class="line"><span class="type">size_t</span> index = SizeClass::<span class="built_in">Index</span>(size);</span><br><span class="line"><span class="comment">// ç”³è¯·-åŠ æ¡¶é”</span></span><br><span class="line">_spanLists[index]._mtx.<span class="built_in">lock</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// é¦–å…ˆä¿è¯æœ‰ä¸€ä¸ªéç©ºçš„Span</span></span><br><span class="line">Span* span = <span class="built_in">GetOneSpan</span>(_spanLists[index], size);</span><br><span class="line"><span class="built_in">assert</span>(span);</span><br><span class="line"><span class="built_in">assert</span>(span-&gt;_freeList);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»spanä¸­è·å–batchNumä¸ªå¯¹è±¡</span></span><br><span class="line"><span class="comment">// å¦‚æœä¸å¤ŸbatchNumï¼Œæœ‰å‡ ä¸ªæ‹¿å‡ ä¸ªï¼Œè¿”å›å®é™…æ‹¿åˆ°çš„ä¸ªæ•°</span></span><br><span class="line"></span><br><span class="line">start = span-&gt;_freeList;</span><br><span class="line">end = start;</span><br><span class="line"><span class="type">int</span> actualNum = <span class="number">1</span>;</span><br><span class="line"><span class="type">size_t</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (i&lt;batchNum &amp;&amp; <span class="built_in">NextObj</span>(end) != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">end = <span class="built_in">NextObj</span>(end);</span><br><span class="line">++i;</span><br><span class="line">++actualNum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‹¿èµ° actualNumä¸ªå¯¹è±¡</span></span><br><span class="line">span-&gt;_freeList = <span class="built_in">NextObj</span>(end);</span><br><span class="line"><span class="built_in">NextObj</span>(end) = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£é”</span></span><br><span class="line">_spanLists[index]._mtx.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> actualNum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å®Œå–„å®Œæˆä¸Šè¿°å†…å®¹åï¼Œæˆ‘ä»¬å›åˆ°æœ€å¼€å§‹ï¼Œthread cacheå‘central cacheç”³è¯·å†…å­˜</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä»ä¸­å¿ƒç¼“å­˜è·å–å¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">ThreadCache::FetchFromCentralCache</span><span class="params">(<span class="type">size_t</span> index, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// æ…¢å¼€å§‹åé¦ˆè°ƒèŠ‚ç®—æ³•</span></span><br><span class="line"><span class="comment">// å…ˆç®—è¦å¤šå°‘ä¸ªsizeå¤§å°çš„å¯¹è±¡</span></span><br><span class="line"><span class="type">size_t</span> batchNum = std::<span class="built_in">min</span>(SizeClass::<span class="built_in">NumMoveSize</span>(size),_freeLists[index].<span class="built_in">MaxSize</span>());</span><br><span class="line"><span class="keyword">if</span> (_freeLists[index].<span class="built_in">MaxSize</span>() == batchNum)</span><br><span class="line">&#123;</span><br><span class="line">_freeLists[index].<span class="built_in">MaxSize</span>() += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// çŸ¥é“è¦å¤šå°‘ä¸ªå¯¹è±¡åå°±å‘central cacheå±‚è¦batchNumä¸ªå¯¹è±¡</span></span><br><span class="line"><span class="type">void</span>* start;</span><br><span class="line"><span class="type">void</span>* end;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> actualNum = CentralCache::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">FetchRangeObj</span>(start, end, batchNum, size);</span><br><span class="line"><span class="built_in">assert</span>(actualNum &gt;= <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (actualNum == <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//åªæœ‰ä¸€ä¸ª</span></span><br><span class="line"><span class="built_in">assert</span>(start == end);</span><br><span class="line"><span class="keyword">return</span> start;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// å°†NextObj(start)-end å¤´æ’è¿›è‡ªç”±é“¾è¡¨ï¼Œè¿”å›start</span></span><br><span class="line">_freeLists[index].<span class="built_in">PushRange</span>(<span class="built_in">NextObj</span>(start), end);</span><br><span class="line"><span class="keyword">return</span> start;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content:encoded>
      
      
      <category domain="https://atong.run/categories/%E9%A1%B9%E7%9B%AE/">é¡¹ç›®</category>
      
      <category domain="https://atong.run/categories/%E9%A1%B9%E7%9B%AE/%E9%AB%98%E5%B9%B6%E5%8F%91%E5%86%85%E5%AD%98%E6%B1%A0/">é«˜å¹¶å‘å†…å­˜æ± </category>
      
      
      <category domain="https://atong.run/tags/%E9%A1%B9%E7%9B%AE/">é¡¹ç›®</category>
      
      
      <comments>https://atong.run/posts/1806624746/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title></title>
      <link>https://atong.run/posts/1/</link>
      <guid>https://atong.run/posts/1/</guid>
      <pubDate>Tue, 07 Feb 2023 13:31:09 GMT</pubDate>
      
      
      
      
      
      
      <comments>https://atong.run/posts/1/#disqus_thread</comments>
      
    </item>
    
  </channel>
</rss>
